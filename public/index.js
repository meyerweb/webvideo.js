var re=(r,t,o)=>{if(!t.has(r))throw TypeError("Cannot "+o)};var e=(r,t,o)=>(re(r,t,"read from private field"),o?o.call(r):t.get(r)),n=(r,t,o)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,o)},a=(r,t,o,i)=>(re(r,t,"write to private field"),i?i.call(r,o):t.set(r,o),o);function M(r){return{videoUrl:r.videoUrl,loglevel:r.loglevel,playState:r.playState.buf(),videoBufferFull:r.videoBufferFull.buf(),audioBufferFull:r.audioBufferFull.buf(),videoDecoderShouldBeDead:r.videoDecoderShouldBeDead.buf(),audioDecoderShouldBeDead:r.audioDecoderShouldBeDead.buf()}}var u;(function(s){s[s.STOPPED=-1]="STOPPED",s[s.PLAYING=0]="PLAYING",s[s.PAUSED=1]="PAUSED",s[s.BUFFERING=2]="BUFFERING",s[s.SEEKING=3]="SEEKING"})(u||(u={}));var v,J=class{constructor(t){n(this,v,void 0);let o=new SharedArrayBuffer(4);a(this,v,new Int32Array(o)),e(this,v)[0]=t}static fromBuffer(t){let o=-1,i=new J(o);return a(i,v,t),i}load(){return Atomics.load(e(this,v),0)}store(t){Atomics.store(e(this,v),0,t),Atomics.notify(e(this,v),0)}buf(){return e(this,v)}},$=J;v=new WeakMap;var S,_,U,g=class{constructor(t){n(this,S,void 0);let o=new SharedArrayBuffer(4);a(this,S,new Int32Array(o)),e(this,S)[0]=t?e(g,_):e(g,U)}static fromBuffer(t){let o=!1,i=new g(o);return a(i,S,t),i}load(){return Atomics.load(e(this,S),0)===e(g,_)}store(t){Atomics.store(e(this,S),0,t?e(g,_):e(g,U)),Atomics.notify(e(this,S),0)}buf(){return e(this,S)}sab(){return e(this,S).buffer}},A=g;S=new WeakMap,_=new WeakMap,U=new WeakMap,n(A,_,1),n(A,U,0);var oe="webvideo-audio-worklet",ie="./player/audio/rendererWorker/worker.js",ae="webvideo-audio-decoder-worker",se="./player/audio/decoderWorker/worker.js",ne="webvideo-video-decoder-worker",de="./player/video/decoderWorker/worker.js";var c;(function(s){s[s.TRACE=0]="TRACE",s[s.DEBUG=1]="DEBUG",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR"})(c||(c={}));var B;(function(l){l.BLACK="[30m",l.RED="[31m",l.GREEN="[32m",l.YELLOW="[33m",l.BLUE="[34m",l.MAGENTA="[35m",l.CYAN="[36m",l.WHITE="[37m",l.NONE=""})(B||(B={}));function ue(r,t){if(t===B.NONE)return r;{let o="[0m";return t+r+o}}function ce(r){return r?`[${r}]`:""}var le={loglevel:3};function me(r){typeof self!="undefined"&&(self.__wv_global_loglevel=r),le.loglevel=r}function he(){return typeof self!="undefined"?self.__wv_global_loglevel:le.loglevel}function H(r,t,o){if(r<he())return;let i=console.log,W=B.NONE;switch(r){case 0:{i=console.log,W=B.WHITE;break}case 1:{i=console.debug,W=B.CYAN;break}case 2:{i=console.info,W=B.GREEN;break}case 3:{i=console.warn;break}case 4:{i=console.error;break}}i(ue([ce(o),t].filter(s=>s).join(" "),W))}function fe(r,t){H(0,r,t)}function pe(r,t){H(1,r,t)}function Se(r,t){H(2,r,t)}function Ee(r,t){H(3,r,t)}function ve(r,t){H(4,r,t)}var T={setLevel:me,trace:fe,debug:pe,info:Se,warn:Ee,error:ve};var y,m,I,Q=class{constructor(t){n(this,y,void 0);n(this,m,[]);n(this,I,void 0);a(this,y,new Worker(de,{type:"module",name:ne})),a(this,I,t.maxVideoFrameLength)}init(t){return new Promise(o=>{e(this,y).onmessage=i=>{switch(i.data.msg){case"VideoDecoder_sendVideoStreamInfo":{o(i.data.videoStream);break}case"VideoDecoder_sendVideoFrame":{this.push(t,i.data.frame);break}}},e(this,y).postMessage({msg:"Main_requestVideoDecoderStart",sharedState:M(t)})})}async uninit(t){return new Promise(o=>{for(e(this,y).onmessage=i=>{switch(i.data.msg){case"VideoDecoder_notifyClosed":{e(this,y).terminate(),o();break}}};e(this,m).length>0;)this.pop(t);t.videoDecoderShouldBeDead.store(!0),e(this,y).postMessage({msg:"Main_requestVideoDecoderClose"})})}start(){e(this,y).postMessage({msg:"Main_requestVideoDecoderDecode"})}dequeue(t,o){for(;e(this,m).length>0;){if(!e(this,m)[0].timestamp){this.pop(t);continue}let i=e(this,m)[0].timestamp-o*1e6;if(i<-.1*1e6){T.trace("chooseFrame(): frame dropped","WVVideoDecoderWorkerFront"),this.pop(t);continue}else return i>.1*1e6?(T.trace("chooseFrame(): frame too fast","WVVideoDecoderWorkerFront"),null):e(this,m)[0]}return null}front(){return e(this,m).length>0?e(this,m)[0]:null}push(t,o){e(this,m).push(o),e(this,m).length>e(this,I)&&t.videoBufferFull.store(!0)}pop(t){let o=e(this,m).shift();o&&(o.close(),e(this,m).length<e(this,I)&&t.videoBufferFull.store(!1))}};y=new WeakMap,m=new WeakMap,I=new WeakMap;var D,X=class{constructor(){n(this,D,void 0);a(this,D,new Worker(se,{type:"module",name:ae}))}init(t){return new Promise(o=>{e(this,D).onmessage=i=>{switch(i.data.msg){case"AudioDecoder_sendAudioStreamInfo":{o(i.data.audioStream);break}}},e(this,D).postMessage({msg:"Main_requestAudioDecoderStart",sharedState:M(t)})})}async uninit(t){return new Promise(o=>{e(this,D).onmessage=i=>{switch(i.data.msg){case"AudioDecoder_notifyClosed":{e(this,D).terminate(),o();break}}},t.audioDecoderShouldBeDead.store(!0),t.audioBufferFull.store(!1),e(this,D).postMessage({msg:"Main_requestAudioDecoderClose"})})}start(t){e(this,D).postMessage({msg:"Main_requestAudioDecoderDecode"},[t])}};D=new WeakMap;var V,N,Z=class{constructor(t,o){n(this,V,void 0);n(this,N,void 0);a(this,V,t),e(this,V).width=o.video.width,e(this,V).height=o.video.height,a(this,N,t.getContext("2d"))}draw(t){e(this,N).drawImage(t,0,0,t.displayWidth,t.displayHeight)}clear(){e(this,N).clearRect(0,0,e(this,V).width,e(this,V).height)}};V=new WeakMap,N=new WeakMap;var h,b,k,ee=class{constructor(t){n(this,h,void 0);n(this,b,void 0);n(this,k,void 0);a(this,h,new AudioContext({sampleRate:t.audio.sampleRate,latencyHint:"playback"})),e(this,h).suspend()}async init(t,o){return await e(this,h).audioWorklet.addModule(ie),a(this,b,new AudioWorkletNode(e(this,h),oe,{processorOptions:{sharedState:M(t)},outputChannelCount:[o.audio.nbChannels]})),a(this,k,new GainNode(e(this,h),{gain:.5})),e(this,b).connect(e(this,k)).connect(e(this,h).destination),e(this,b).port}async start(){await e(this,h).resume()}async pause(){await e(this,h).suspend()}async close(){e(this,k)?.disconnect(),e(this,b)?.disconnect(),e(this,b)?.port.close(),await e(this,h).close()}currentTime(){return Math.max(e(this,h).currentTime-e(this,h).baseLatency,0)}};h=new WeakMap,b=new WeakMap,k=new WeakMap;var C,d,F,f,E,z,O,p,x,P,Y=class{constructor(t){n(this,C,void 0);n(this,d,void 0);n(this,F,void 0);n(this,f,void 0);n(this,E,void 0);n(this,z,10);n(this,O,void 0);n(this,p,void 0);n(this,x,void 0);n(this,P,!1);a(this,C,t),a(this,d,{videoUrl:t.videoUrl,loglevel:t.loglevel??c.WARN,playState:new $(u.STOPPED),audioBufferFull:new A(!1),videoBufferFull:new A(!1),videoDecoderShouldBeDead:new A(!1),audioDecoderShouldBeDead:new A(!1)}),T.setLevel(e(this,d).loglevel)}async setUrl(t,o){return await this.unload(),e(this,d).videoUrl=t,this.load(o)}async load(t){if(e(this,P))throw Error("load() is already called");a(this,P,!0),e(this,d).videoDecoderShouldBeDead.store(!1),e(this,d).audioDecoderShouldBeDead.store(!1),a(this,E,new Q({maxVideoFrameLength:e(this,z)})),a(this,O,new X),e(this,d).playState.store(u.BUFFERING),await t?.onStart?.();{a(this,p,await e(this,E).init(e(this,d))),a(this,x,await e(this,O).init(e(this,d))),a(this,F,new Z(e(this,C).canvasElem,e(this,p))),a(this,f,new ee(e(this,x)));let o=await e(this,f).init(e(this,d),e(this,x));e(this,E).start(),e(this,O).start(o),await new Promise(W=>{let s=e(this,d);requestAnimationFrame(function j(){if(s.playState.load()!==u.BUFFERING||s.videoBufferFull.load()&&s.audioBufferFull.load())return W(0);requestAnimationFrame(j)})});let i=e(this,E).front();i&&e(this,F).draw(i)}await t?.onEnd?.(),e(this,d).playState.store(u.PAUSED)}async unload(t){!e(this,P)||(a(this,P,!1),e(this,d).playState.store(u.STOPPED),await t?.onStart?.(),e(this,F)?.clear(),await e(this,f)?.close(),await e(this,E).uninit(e(this,d)),await e(this,O).uninit(e(this,d)),e(this,d).videoBufferFull.store(!1),e(this,d).audioBufferFull.store(!1),a(this,E,null),a(this,O,null),await t?.onEnd?.())}loadCalled(){return e(this,P)}playState(){return e(this,d).playState.load()}canPlay(){return e(this,d).audioBufferFull.load()}async play(){if(!e(this,f))throw Error("WVAudioRenderer is undefined");e(this,d).playState.store(u.PLAYING),await e(this,f).start(),this.mainLoop()}async pause(){if(!e(this,f))throw Error("WVAudioRenderer is undefined");e(this,d).playState.store(u.PAUSED),await e(this,f).pause()}async mainLoop(){if(e(this,d).playState.load()!==u.PLAYING)return;if(!e(this,F)||!e(this,f)){T.error("Renderers are not initialized yet","WVPlayer");return}let t=e(this,f).currentTime(),o=e(this,E).dequeue(e(this,d),t);o&&(e(this,F).draw(o),e(this,E).pop(e(this,d))),t>=this.length()&&(await this.pause(),await this.onEOS()),requestAnimationFrame(this.mainLoop.bind(this))}duration(){return e(this,p).duration}timescale(){return e(this,p).timescale}length(){return e(this,p).duration/e(this,p).timescale}lengthMS(){return e(this,p).duration/e(this,p).timescale*1e3}bitrate(){return e(this,p).bitrate}};C=new WeakMap,d=new WeakMap,F=new WeakMap,f=new WeakMap,E=new WeakMap,z=new WeakMap,O=new WeakMap,p=new WeakMap,x=new WeakMap,P=new WeakMap,Y.LogLevel=c;var w,te=[["./assets/TearsOfSteel.mp4","[Excerpt] \u201CTears of Steel\u201D by Blender Foundation (CC BY 3.0)"],["./assets/ElephantsDream.mp4","[Excerpt] \u201CElephants Dream\u201D by Blender Foundation (CC BY)"]],R;(function(o){o.FONTAWESOME_PLAY="&#xf04b;",o.FONTAWESOME_PAUSE="&#xf04c;"})(R||(R={}));function ye(r){r.style.display=""}function De(r){r.style.display="none"}function we(r){r.style.display=""}function We(r){r.style.display="none"}function K(r,t){t.style.opacity=r?"0":"1"}function q(r,t){t.innerHTML=r}window.addEventListener("beforeunload",r=>{function t(o){let i=new Date().getTime();for(;new Date().getTime()-i<o;);}w?.loadCalled()&&w?.unload(),r.preventDefault(),r.returnValue=""});window.addEventListener("load",async()=>{let r=document.querySelector("select#video_select"),t=document.querySelector("#play_btn_wrapper"),o=document.querySelector("#loader_wrapper"),i=document.querySelector("#play_btn"),W=document.querySelector("#title_area h3"),s=document.querySelector("#title_area"),j=te.length,L=0;w=new Y({canvasElem:document.querySelector("#monitor")}),w.onEOS=async()=>{L++,await G()},q(R.FONTAWESOME_PLAY,i),i.addEventListener("click",async()=>{switch(w.playState()){case u.PAUSED:{w.canPlay()&&(await w.play(),K(!0,t),q(R.FONTAWESOME_PAUSE,i));break}case u.PLAYING:{await w.pause(),K(!1,t),q(R.FONTAWESOME_PLAY,i);break}case u.STOPPED:await G()}}),s.addEventListener("click",async()=>{await G()});async function G(){L>=j&&(L=0);let l=new URL(te[L][0],location.origin).href;await w.setUrl(l,{onStart:async()=>{We(t),ye(o)},onEnd:async()=>{De(o),we(t),K(!1,t),q(R.FONTAWESOME_PLAY,i)}}),await w.play(),K(!0,t),q(R.FONTAWESOME_PAUSE,i),W.textContent=te[L][1]}await G()});
