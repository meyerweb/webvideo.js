var ve=(i,t)=>()=>(t||i((t={exports:{}}).exports,t),t.exports);var he=(i,t,r)=>{if(!t.has(i))throw TypeError("Cannot "+r)};var e=(i,t,r)=>(he(i,t,"read from private field"),r?r.call(i):t.get(i)),l=(i,t,r)=>{if(t.has(i))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(i):t.set(i,r)},n=(i,t,r,o)=>(he(i,t,"write to private field"),o?o.call(i,r):t.set(i,r),r);var Ee=ve(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});var Ve={vertical:!1,borderSize:2,fontSize:9,backgroundColor:"black",tickColor:"#ddd",labelColor:"#ddd",gradient:["red 1%","#ff0 16%","lime 45%","#080 100%"],dbRangeMin:-48,dbRangeMax:0,dbTickSize:6,maskTransition:"0.1s",audioMeterStandard:"peak-sample",peakHoldDuration:0};function Q(i){return 20*(t=10,r=i,Math.log(r)/Math.log(t));var t,r}function Re(i,t){let{dbRangeMin:r,dbRangeMax:o,dbTickSize:c,fontSize:s,borderSize:p,tickColor:m,vertical:u}=t,a=function(E,v,X){let ce=[];for(let J=Math.floor(E)+1;J<=v;J+=1)J%X==0&&ce.push(J);return ce}(r,o,c),d=document.createElement("div");return d.style.position="relative",u?(d.style.height=`calc(100% - ${1.5*s}px)`,d.style.width=2*s+"px",d.style.marginTop=1.5*s+"px"):(d.style.height=1.5*s+"px",d.style.width=`calc(100% - ${3*s}px)`,d.style.marginRight=3*s+"px"),i.appendChild(d),a.map(E=>{let v=document.createElement("div");d.appendChild(v),v.style.position="absolute",v.style.color=m,v.style.fontSize=`${s}px`,v.textContent=E.toString();let X=(o-E)/(o-r)*100;return u?(v.style.top=`calc(${X}% - ${s/2}px)`,v.style.right=`${p}px`,v.style.textAlign="right"):(v.style.right=`${X}%`,v.style.transform="translateX(50%)"),v})}ne.WebAudioPeakMeter=class{constructor(i,t,r={}){this.srcNode=i,this.config=Object.assign(Object.assign({},Ve),r),this.channelCount=i.channelCount,this.tempPeaks=new Array(this.channelCount).fill(0),this.heldPeaks=new Array(this.channelCount).fill(0),this.peakHoldTimeouts=new Array(this.channelCount).fill(0),t&&(this.parent=function(o,c){let{backgroundColor:s,borderSize:p,vertical:m}=c,u=document.createElement("div");return u.style.backgroundColor=s,u.style.boxSizing="border-box",u.style.height="100%",u.style.padding=`${p}px`,m&&(u.style.display="flex",u.style.flexDirection="row-reverse"),o.appendChild(u),u}(t,this.config),this.channelElements=function(o,c,s){let{fontSize:p,vertical:m,borderSize:u}=c,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",m?(a.style.height="100%",a.style.width=`calc(100% - ${2*p}px)`):(a.style.height=`calc(100% - ${1.5*p}px)`,a.style.width="100%",a.style.flexDirection="column"),o.appendChild(a);let d=(s-1)*u;return Array.from(Array(s).keys()).map(()=>{let E=document.createElement("div");return m?(E.style.height="100%",E.style.width=`calc((100% - ${d}px) / ${s})`):(E.style.display="flex",E.style.height=`calc((100% - ${d}px) / ${s})`,E.style.width="100%",E.style.flexDirection="row-reverse"),a.appendChild(E),E})}(this.parent,this.config,this.channelCount),this.peakLabels=function(o,c){let{labelColor:s,fontSize:p,vertical:m}=c;return o.map(u=>{let a=document.createElement("div");return a.style.color=s,a.style.fontSize=`${p}px`,a.textContent="-\u221E",m?(a.style.height=1.5*p+"px",a.style.width="100%",a.style.textAlign="center"):(a.style.width=3*p+"px",a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center"),u.appendChild(a),a})}(this.channelElements,this.config),this.bars=function(o,c){let{gradient:s,vertical:p,fontSize:m,maskTransition:u}=c;return o.map(a=>{let d=document.createElement("div");return d.style.transition=`clip-path ${u}`,p?(d.style.height=`calc(100% - ${1.5*m}px)`,d.style.width="100%",d.style.backgroundImage=`linear-gradient(to bottom, ${s.join(", ")})`):(d.style.height="100%",d.style.width=`calc(100% - ${3*m}px)`,d.style.backgroundImage=`linear-gradient(to left, ${s.join(", ")})`),a.appendChild(d),d})}(this.channelElements,this.config),this.ticks=Re(this.parent,this.config),this.parent.addEventListener("click",this.clearPeaks.bind(this)),this.paintMeter()),this.initNode()}async initNode(){let{audioMeterStandard:i}=this.config;try{this.node=new AudioWorkletNode(this.srcNode.context,`${i}-processor`,{parameterData:{}})}catch(t){let r=new Blob([i==="true-peak"?'function s(s,t,e){const o=[];for(let r=0;r<e;r+=1){let i=0,n=0;for(let o=r;o<t.length;o+=e)n+=t[o]*s[s.length-1-i],i+=1;o.push(n)}return o}class t extends AudioWorkletProcessor{constructor(){super(),this.numCoefficients=33,this.sampleRate=sampleRate,this.upsampleFactor=this.sampleRate>8e4?2:4,this.lpfCoefficients=function(s,t){const e=[],o=1/(4*t),r=1-Math.ceil(s/2),i=Math.floor(s/2);for(let n=r;n<=i;n++){const r=.54+.46*Math.cos(2*Math.PI*n/s);let i=0;i=0==n?2*o:Math.sin(2*Math.PI*o*n)/(Math.PI*n),i=r*i*t,e.push(i)}return e}(this.numCoefficients,this.upsampleFactor),this.lpfBuffers=[],this.port.postMessage({type:"message",message:`true peak inited? ${this.sampleRate}`}),this.processCount=0}process(t){const e=t[0];if(e.length>this.lpfBuffers.length)for(let s=1;s<=e.length;s+=1)s>this.lpfBuffers.length&&this.lpfBuffers.push(new Array(this.numCoefficients).fill(0));const o=function(t,e,o,r){return t.map(((t,i)=>{const n=e[i];let h=0;for(let e=0;e<t.length;e++){const i=t[e];n.push(i),n.shift();const a=s(n,o,r);for(let s=0;s<a.length;s++){const t=Math.abs(a[s]);t>h&&(h=t)}}return h}))}(e,this.lpfBuffers,this.lpfCoefficients,this.upsampleFactor);return this.port.postMessage({type:"peaks",peaks:o}),this.processCount%100==0&&this.port.postMessage({type:"message",message:this.lpfBuffers}),this.processCount+=1,!0}}try{registerProcessor("true-peak-processor",t)}catch(s){console.info("Failed to register true-peak-processor. This probably means it was already registered.")}\n':`class e extends AudioWorkletProcessor{process(e){const s=function(e){return e.map((e=>{let s=0;for(let r=0;r<e.length;r++){const t=Math.abs(e[r]);t>s&&(s=t)}return s}))}(e[0]);return this.port.postMessage({type:"peaks",peaks:s}),!0}}try{registerProcessor("peak-sample-processor",e)}catch(e){console.info("Failed to register peak-sample-processor. This probably means it was already registered.")}
`],{type:"application/javascript"}),o=URL.createObjectURL(r);await this.srcNode.context.audioWorklet.addModule(o),this.node=new AudioWorkletNode(this.srcNode.context,`${i}-processor`,{parameterData:{}})}this.node.port.onmessage=t=>this.handleNodePortMessage(t),this.srcNode.connect(this.node).connect(this.srcNode.context.destination)}handleNodePortMessage(i){if(i.data.type==="message"&&console.log(i.data.message),i.data.type==="peaks"){let{peaks:t}=i.data;for(let r=0;r<this.tempPeaks.length;r+=1)t.length>r?this.tempPeaks[r]=t[r]:this.tempPeaks[r]=0;t.length<this.channelCount&&this.tempPeaks.fill(0,t.length);for(let r=0;r<t.length;r+=1)t[r]>this.heldPeaks[r]&&(this.heldPeaks[r]=t[r],this.peakHoldTimeouts[r]&&clearTimeout(this.peakHoldTimeouts[r]),this.config.peakHoldDuration&&(this.peakHoldTimeouts[r]=window.setTimeout(()=>{this.clearPeak(r)},this.config.peakHoldDuration)))}}paintMeter(){let{dbRangeMin:i,dbRangeMax:t,vertical:r}=this.config;this.bars&&this.bars.forEach((o,c)=>{let s=function(p,m,u,a){let d=Math.floor(100*(u-p)/(u-m));return d>100&&(d=100),d<0&&(d=0),a?`inset(${d}% 0 0)`:`inset(0 ${d}% 0 0)`}(Q(this.tempPeaks[c]),i,t,r);o.style.clipPath=s}),this.peakLabels&&this.peakLabels.forEach((o,c)=>{if(this.heldPeaks[c]===0)o.textContent="-\u221E";else{let s=Q(this.heldPeaks[c]);o.textContent=s.toFixed(1)}}),this.animationRequestId=window.requestAnimationFrame(this.paintMeter.bind(this))}clearPeak(i){this.heldPeaks[i]=this.tempPeaks[i]}clearPeaks(){for(let i=0;i<this.heldPeaks.length;i+=1)this.clearPeak(i)}getPeaks(){return{current:this.tempPeaks,maxes:this.heldPeaks,currentDB:this.tempPeaks.map(Q),maxesDB:this.heldPeaks.map(Q)}}cleanup(){this.node&&this.node.disconnect(),this.parent&&(this.parent.removeEventListener("click",this.clearPeaks.bind(this)),this.animationRequestId!==void 0&&window.cancelAnimationFrame(this.animationRequestId),this.parent.remove())}}});function C(i){return{videoUrl:i.videoUrl,loglevel:i.loglevel,playState:i.playState.buf(),videoBufferFull:i.videoBufferFull.buf(),audioBufferFull:i.audioBufferFull.buf(),videoDecoderShouldBeDead:i.videoDecoderShouldBeDead.buf(),audioDecoderShouldBeDead:i.audioDecoderShouldBeDead.buf()}}var f;(function(s){s[s.STOPPED=-1]="STOPPED",s[s.PLAYING=0]="PLAYING",s[s.PAUSED=1]="PAUSED",s[s.BUFFERING=2]="BUFFERING",s[s.SEEKING=3]="SEEKING"})(f||(f={}));var D,re=class{constructor(t){l(this,D,void 0);let r=new SharedArrayBuffer(4);n(this,D,new Int32Array(r)),e(this,D)[0]=t}static fromBuffer(t){let r=-1,o=new re(r);return n(o,D,t),o}load(){return Atomics.load(e(this,D),0)}store(t){Atomics.store(e(this,D),0,t),Atomics.notify(e(this,D),0)}buf(){return e(this,D)}},ie=re;D=new WeakMap;var k,N,q,R=class{constructor(t){l(this,k,void 0);let r=new SharedArrayBuffer(4);n(this,k,new Int32Array(r)),e(this,k)[0]=t?e(R,N):e(R,q)}static fromBuffer(t){let r=!1,o=new R(r);return n(o,k,t),o}load(){return Atomics.load(e(this,k),0)===e(R,N)}store(t){Atomics.store(e(this,k),0,t?e(R,N):e(R,q)),Atomics.notify(e(this,k),0)}buf(){return e(this,k)}sab(){return e(this,k).buffer}},V=R;k=new WeakMap,N=new WeakMap,q=new WeakMap,l(V,N,1),l(V,q,0);var ue="webvideo-audio-worklet",me="./player/audio/rendererWorker/worker.js",pe="webvideo-audio-decoder-worker",fe="./player/audio/decoderWorker/worker.js",ye="webvideo-video-decoder-worker",ge="./player/video/decoderWorker/worker.js";var y;(function(s){s[s.TRACE=0]="TRACE",s[s.DEBUG=1]="DEBUG",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR"})(y||(y={}));var I;(function(a){a.BLACK="[30m",a.RED="[31m",a.GREEN="[32m",a.YELLOW="[33m",a.BLUE="[34m",a.MAGENTA="[35m",a.CYAN="[36m",a.WHITE="[37m",a.NONE=""})(I||(I={}));function we(i,t){if(t===I.NONE)return i;{let r="[0m";return t+i+r}}function be(i){return i?`[${i}]`:""}var Se={loglevel:3};function ke(i){typeof self!="undefined"&&(self.__wv_global_loglevel=i),Se.loglevel=i}function Ae(){return typeof self!="undefined"?self.__wv_global_loglevel:Se.loglevel}function G(i,t,r){if(i<Ae())return;let o=console.log,c=I.NONE;switch(i){case 0:{o=console.log,c=I.WHITE;break}case 1:{o=console.debug,c=I.CYAN;break}case 2:{o=console.info,c=I.GREEN;break}case 3:{o=console.warn;break}case 4:{o=console.error;break}}o(we([be(r),t].filter(s=>s).join(" "),c))}function De(i,t){G(0,i,t)}function Pe(i,t){G(1,i,t)}function We(i,t){G(2,i,t)}function Me(i,t){G(3,i,t)}function xe(i,t){G(4,i,t)}var L={setLevel:ke,trace:De,debug:Pe,info:We,warn:Me,error:xe};var P,g,U,oe=class{constructor(t){l(this,P,void 0);l(this,g,[]);l(this,U,void 0);n(this,P,new Worker(ge,{type:"module",name:ye})),n(this,U,t.maxVideoFrameLength)}init(t){return new Promise(r=>{e(this,P).onmessage=o=>{switch(o.data.msg){case"VideoDecoder_sendVideoStreamInfo":{r(o.data.videoStream);break}case"VideoDecoder_sendVideoFrame":{this.push(t,o.data.frame);break}}},e(this,P).postMessage({msg:"Main_requestVideoDecoderStart",sharedState:C(t)})})}async uninit(t){return new Promise(r=>{for(e(this,P).onmessage=o=>{switch(o.data.msg){case"VideoDecoder_notifyClosed":{e(this,P).terminate(),r();break}}};e(this,g).length>0;)this.pop(t);t.videoDecoderShouldBeDead.store(!0),e(this,P).postMessage({msg:"Main_requestVideoDecoderClose"})})}start(){e(this,P).postMessage({msg:"Main_requestVideoDecoderDecode"})}dequeue(t,r){for(;e(this,g).length>0;){if(!e(this,g)[0].timestamp){this.pop(t);continue}let o=e(this,g)[0].timestamp-r*1e6;if(o<-.1*1e6){L.trace("chooseFrame(): frame dropped","WVVideoDecoderWorkerFront"),this.pop(t);continue}else return o>.1*1e6?(L.trace("chooseFrame(): frame too fast","WVVideoDecoderWorkerFront"),null):e(this,g)[0]}return null}front(){return e(this,g).length>0?e(this,g)[0]:null}push(t,r){e(this,g).push(r),e(this,g).length>e(this,U)&&t.videoBufferFull.store(!0)}pop(t){let r=e(this,g).shift();r&&(r.close(),e(this,g).length<e(this,U)&&t.videoBufferFull.store(!1))}};P=new WeakMap,g=new WeakMap,U=new WeakMap;var W,se=class{constructor(){l(this,W,void 0);n(this,W,new Worker(fe,{type:"module",name:pe}))}init(t){return new Promise(r=>{e(this,W).onmessage=o=>{switch(o.data.msg){case"AudioDecoder_sendAudioStreamInfo":{r(o.data.audioStream);break}}},e(this,W).postMessage({msg:"Main_requestAudioDecoderStart",sharedState:C(t)})})}async uninit(t){return new Promise(r=>{e(this,W).onmessage=o=>{switch(o.data.msg){case"AudioDecoder_notifyClosed":{e(this,W).terminate(),r();break}}},t.audioDecoderShouldBeDead.store(!0),t.audioBufferFull.store(!1),e(this,W).postMessage({msg:"Main_requestAudioDecoderClose"})})}start(t){e(this,W).postMessage({msg:"Main_requestAudioDecoderDecode"},[t])}};W=new WeakMap;var F,H,ae=class{constructor(t,r){l(this,F,void 0);l(this,H,void 0);n(this,F,t),e(this,F).width=r.video.width,e(this,F).height=r.video.height,n(this,H,t.getContext("2d"))}draw(t){e(this,H).drawImage(t,0,0,t.displayWidth,t.displayHeight)}clear(){e(this,H).clearRect(0,0,e(this,F).width,e(this,F).height)}};F=new WeakMap,H=new WeakMap;var Fe=Ee(),S,x,$,j,le=class{constructor(t){l(this,S,void 0);l(this,x,void 0);l(this,$,void 0);l(this,j,void 0);n(this,S,new AudioContext({sampleRate:t.audio.sampleRate,latencyHint:"playback"})),e(this,S).suspend()}async init(t,r){await e(this,S).audioWorklet.addModule(me),n(this,x,new AudioWorkletNode(e(this,S),ue,{processorOptions:{sharedState:C(t)},outputChannelCount:[r.audio.nbChannels]})),n(this,$,new GainNode(e(this,S),{gain:.5})),e(this,x).connect(e(this,$)).connect(e(this,S).destination);var o=document.getElementById("peak-meter");let c={vertical:!0};return n(this,j,new Fe.WebAudioPeakMeter(e(this,x),o,c)),e(this,x).port}async start(){await e(this,S).resume()}async pause(){await e(this,S).suspend()}async close(){e(this,j).cleanup(),e(this,$)?.disconnect(),e(this,x)?.disconnect(),e(this,x)?.port.close(),await e(this,S).close()}currentTime(){return Math.max(e(this,S).currentTime-e(this,S).baseLatency,0)}};S=new WeakMap,x=new WeakMap,$=new WeakMap,j=new WeakMap;var Y,h,B,w,A,ee,O,b,z,T,Z=class{constructor(t){l(this,Y,void 0);l(this,h,void 0);l(this,B,void 0);l(this,w,void 0);l(this,A,void 0);l(this,ee,10);l(this,O,void 0);l(this,b,void 0);l(this,z,void 0);l(this,T,!1);n(this,Y,t),n(this,h,{videoUrl:t.videoUrl,loglevel:t.loglevel??y.WARN,playState:new ie(f.STOPPED),audioBufferFull:new V(!1),videoBufferFull:new V(!1),videoDecoderShouldBeDead:new V(!1),audioDecoderShouldBeDead:new V(!1)}),L.setLevel(e(this,h).loglevel)}async setUrl(t,r){return await this.unload(),e(this,h).videoUrl=t,this.load(r)}async load(t){if(e(this,T))throw Error("load() is already called");n(this,T,!0),e(this,h).videoDecoderShouldBeDead.store(!1),e(this,h).audioDecoderShouldBeDead.store(!1),n(this,A,new oe({maxVideoFrameLength:e(this,ee)})),n(this,O,new se),e(this,h).playState.store(f.BUFFERING),await t?.onStart?.();{n(this,b,await e(this,A).init(e(this,h))),n(this,z,await e(this,O).init(e(this,h))),n(this,B,new ae(e(this,Y).canvasElem,e(this,b))),n(this,w,new le(e(this,z)));let r=await e(this,w).init(e(this,h),e(this,z));e(this,A).start(),e(this,O).start(r),await new Promise(c=>{let s=e(this,h);requestAnimationFrame(function p(){if(s.playState.load()!==f.BUFFERING||s.videoBufferFull.load()&&s.audioBufferFull.load())return c(0);requestAnimationFrame(p)})});let o=e(this,A).front();o&&e(this,B).draw(o)}await t?.onEnd?.(),e(this,h).playState.store(f.PAUSED)}async unload(t){!e(this,T)||(n(this,T,!1),e(this,h).playState.store(f.STOPPED),await t?.onStart?.(),e(this,B)?.clear(),await e(this,w)?.close(),await e(this,A).uninit(e(this,h)),await e(this,O).uninit(e(this,h)),e(this,h).videoBufferFull.store(!1),e(this,h).audioBufferFull.store(!1),n(this,A,null),n(this,O,null),await t?.onEnd?.())}loadCalled(){return e(this,T)}playState(){return e(this,h).playState.load()}canPlay(){return e(this,h).audioBufferFull.load()}async play(){if(!e(this,w))throw Error("WVAudioRenderer is undefined");e(this,h).playState.store(f.PLAYING),await e(this,w).start(),this.mainLoop()}async pause(){if(!e(this,w))throw Error("WVAudioRenderer is undefined");e(this,h).playState.store(f.PAUSED),await e(this,w).pause()}async mainLoop(){if(e(this,h).playState.load()!==f.PLAYING)return;if(!e(this,B)||!e(this,w)){L.error("Renderers are not initialized yet","WVPlayer");return}let t=e(this,w).currentTime(),r=e(this,A).dequeue(e(this,h),t);r&&(e(this,B).draw(r),e(this,A).pop(e(this,h))),t>=this.length()&&(await this.pause(),await this.onEOS()),requestAnimationFrame(this.mainLoop.bind(this))}duration(){return e(this,b).duration}timescale(){return e(this,b).timescale}length(){return e(this,b).duration/e(this,b).timescale}lengthMS(){return e(this,b).duration/e(this,b).timescale*1e3}bitrate(){return e(this,b).bitrate}};Y=new WeakMap,h=new WeakMap,B=new WeakMap,w=new WeakMap,A=new WeakMap,ee=new WeakMap,O=new WeakMap,b=new WeakMap,z=new WeakMap,T=new WeakMap,Z.LogLevel=y;var M,de=[["./assets/TearsOfSteel.mp4","[Excerpt] \u201CTears of Steel\u201D by Blender Foundation (CC BY 3.0)"],["./assets/ElephantsDream.mp4","[Excerpt] \u201CElephants Dream\u201D by Blender Foundation (CC BY)"]],_;(function(r){r.FONTAWESOME_PLAY="&#xf04b;",r.FONTAWESOME_PAUSE="&#xf04c;"})(_||(_={}));function Be(i){i.style.display=""}function Oe(i){i.style.display="none"}function Te(i){i.style.display=""}function Ie(i){i.style.display="none"}function te(i,t){t.style.opacity=i?"0":"1"}function K(i,t){t.innerHTML=i}window.addEventListener("beforeunload",i=>{function t(r){let o=new Date().getTime();for(;new Date().getTime()-o<r;);}M?.loadCalled()&&M?.unload(),i.preventDefault(),i.returnValue=""});window.addEventListener("load",async()=>{let i=document.querySelector("select#video_select"),t=document.querySelector("#play_btn_wrapper"),r=document.querySelector("#loader_wrapper"),o=document.querySelector("#play_btn"),c=document.querySelector("#title_area h3"),s=document.querySelector("#title_area"),p=de.length,m=0;M=new Z({canvasElem:document.querySelector("#monitor")}),M.onEOS=async()=>{m++,await u()},K(_.FONTAWESOME_PLAY,o),o.addEventListener("click",async()=>{switch(M.playState()){case f.PAUSED:{M.canPlay()&&(await M.play(),te(!0,t),K(_.FONTAWESOME_PAUSE,o));break}case f.PLAYING:{await M.pause(),te(!1,t),K(_.FONTAWESOME_PLAY,o);break}case f.STOPPED:await u()}}),s.addEventListener("click",async()=>{await u()});async function u(){m>=p&&(m=0);let a=new URL(de[m][0],location.origin).href;await M.setUrl(a,{onStart:async()=>{Ie(t),Be(r)},onEnd:async()=>{Oe(r),Te(t),te(!1,t),K(_.FONTAWESOME_PLAY,o)}}),await M.play(),te(!0,t),K(_.FONTAWESOME_PAUSE,o),c.textContent=de[m][1]}await u()});
