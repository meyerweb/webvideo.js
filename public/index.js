var ve=(r,t)=>()=>(t||r((t={exports:{}}).exports,t),t.exports);var he=(r,t,i)=>{if(!t.has(r))throw TypeError("Cannot "+i)};var e=(r,t,i)=>(he(r,t,"read from private field"),i?i.call(r):t.get(r)),c=(r,t,i)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,i)},n=(r,t,i,o)=>(he(r,t,"write to private field"),o?o.call(r,i):t.set(r,i),i);var Ee=ve(ne=>{"use strict";Object.defineProperty(ne,"__esModule",{value:!0});var Ve={vertical:!1,borderSize:2,fontSize:9,backgroundColor:"black",tickColor:"#ddd",labelColor:"#ddd",gradient:["red 1%","#ff0 16%","lime 45%","#080 100%"],dbRangeMin:-48,dbRangeMax:0,dbTickSize:6,maskTransition:"0.1s",audioMeterStandard:"peak-sample",peakHoldDuration:0};function Q(r){return 20*(t=10,i=r,Math.log(i)/Math.log(t));var t,i}function Re(r,t){let{dbRangeMin:i,dbRangeMax:o,dbTickSize:h,fontSize:s,borderSize:f,tickColor:u,vertical:m}=t,a=function(S,p,L){let ce=[];for(let J=Math.floor(S)+1;J<=p;J+=1)J%L==0&&ce.push(J);return ce}(i,o,h),l=document.createElement("div");return l.style.position="relative",m?(l.style.height=`calc(100% - ${1.5*s}px)`,l.style.width=2*s+"px",l.style.marginTop=1.5*s+"px"):(l.style.height=1.5*s+"px",l.style.width=`calc(100% - ${3*s}px)`,l.style.marginRight=3*s+"px"),r.appendChild(l),a.map(S=>{let p=document.createElement("div");l.appendChild(p),p.style.position="absolute",p.style.color=u,p.style.fontSize=`${s}px`,p.textContent=S.toString();let L=(o-S)/(o-i)*100;return m?(p.style.top=`calc(${L}% - ${s/2}px)`,p.style.right=`${f}px`,p.style.textAlign="right"):(p.style.right=`${L}%`,p.style.transform="translateX(50%)"),p})}ne.WebAudioPeakMeter=class{constructor(r,t,i={}){this.srcNode=r,this.config=Object.assign(Object.assign({},Ve),i),this.channelCount=r.channelCount,this.tempPeaks=new Array(this.channelCount).fill(0),this.heldPeaks=new Array(this.channelCount).fill(0),this.peakHoldTimeouts=new Array(this.channelCount).fill(0),t&&(this.parent=function(o,h){let{backgroundColor:s,borderSize:f,vertical:u}=h,m=document.createElement("div");return m.style.backgroundColor=s,m.style.boxSizing="border-box",m.style.height="100%",m.style.padding=`${f}px`,u&&(m.style.display="flex",m.style.flexDirection="row-reverse"),o.appendChild(m),m}(t,this.config),this.channelElements=function(o,h,s){let{fontSize:f,vertical:u,borderSize:m}=h,a=document.createElement("div");a.style.display="flex",a.style.justifyContent="space-between",u?(a.style.height="100%",a.style.width=`calc(100% - ${2*f}px)`):(a.style.height=`calc(100% - ${1.5*f}px)`,a.style.width="100%",a.style.flexDirection="column"),o.appendChild(a);let l=(s-1)*m;return Array.from(Array(s).keys()).map(()=>{let S=document.createElement("div");return u?(S.style.height="100%",S.style.width=`calc((100% - ${l}px) / ${s})`):(S.style.display="flex",S.style.height=`calc((100% - ${l}px) / ${s})`,S.style.width="100%",S.style.flexDirection="row-reverse"),a.appendChild(S),S})}(this.parent,this.config,this.channelCount),this.peakLabels=function(o,h){let{labelColor:s,fontSize:f,vertical:u}=h;return o.map(m=>{let a=document.createElement("div");return a.style.color=s,a.style.fontSize=`${f}px`,a.textContent="-\u221E",u?(a.style.height=1.5*f+"px",a.style.width="100%",a.style.textAlign="center"):(a.style.width=3*f+"px",a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center"),m.appendChild(a),a})}(this.channelElements,this.config),this.bars=function(o,h){let{gradient:s,vertical:f,fontSize:u,maskTransition:m}=h;return o.map(a=>{let l=document.createElement("div");return l.style.transition=`clip-path ${m}`,f?(l.style.height=`calc(100% - ${1.5*u}px)`,l.style.width="100%",l.style.backgroundImage=`linear-gradient(to bottom, ${s.join(", ")})`):(l.style.height="100%",l.style.width=`calc(100% - ${3*u}px)`,l.style.backgroundImage=`linear-gradient(to left, ${s.join(", ")})`),a.appendChild(l),l})}(this.channelElements,this.config),this.ticks=Re(this.parent,this.config),this.parent.addEventListener("click",this.clearPeaks.bind(this)),this.paintMeter()),this.initNode()}async initNode(){let{audioMeterStandard:r}=this.config;try{this.node=new AudioWorkletNode(this.srcNode.context,`${r}-processor`,{parameterData:{}})}catch(t){let i=new Blob([r==="true-peak"?'function s(s,t,e){const o=[];for(let r=0;r<e;r+=1){let i=0,n=0;for(let o=r;o<t.length;o+=e)n+=t[o]*s[s.length-1-i],i+=1;o.push(n)}return o}class t extends AudioWorkletProcessor{constructor(){super(),this.numCoefficients=33,this.sampleRate=sampleRate,this.upsampleFactor=this.sampleRate>8e4?2:4,this.lpfCoefficients=function(s,t){const e=[],o=1/(4*t),r=1-Math.ceil(s/2),i=Math.floor(s/2);for(let n=r;n<=i;n++){const r=.54+.46*Math.cos(2*Math.PI*n/s);let i=0;i=0==n?2*o:Math.sin(2*Math.PI*o*n)/(Math.PI*n),i=r*i*t,e.push(i)}return e}(this.numCoefficients,this.upsampleFactor),this.lpfBuffers=[],this.port.postMessage({type:"message",message:`true peak inited? ${this.sampleRate}`}),this.processCount=0}process(t){const e=t[0];if(e.length>this.lpfBuffers.length)for(let s=1;s<=e.length;s+=1)s>this.lpfBuffers.length&&this.lpfBuffers.push(new Array(this.numCoefficients).fill(0));const o=function(t,e,o,r){return t.map(((t,i)=>{const n=e[i];let h=0;for(let e=0;e<t.length;e++){const i=t[e];n.push(i),n.shift();const a=s(n,o,r);for(let s=0;s<a.length;s++){const t=Math.abs(a[s]);t>h&&(h=t)}}return h}))}(e,this.lpfBuffers,this.lpfCoefficients,this.upsampleFactor);return this.port.postMessage({type:"peaks",peaks:o}),this.processCount%100==0&&this.port.postMessage({type:"message",message:this.lpfBuffers}),this.processCount+=1,!0}}try{registerProcessor("true-peak-processor",t)}catch(s){console.info("Failed to register true-peak-processor. This probably means it was already registered.")}\n':`class e extends AudioWorkletProcessor{process(e){const s=function(e){return e.map((e=>{let s=0;for(let r=0;r<e.length;r++){const t=Math.abs(e[r]);t>s&&(s=t)}return s}))}(e[0]);return this.port.postMessage({type:"peaks",peaks:s}),!0}}try{registerProcessor("peak-sample-processor",e)}catch(e){console.info("Failed to register peak-sample-processor. This probably means it was already registered.")}
`],{type:"application/javascript"}),o=URL.createObjectURL(i);await this.srcNode.context.audioWorklet.addModule(o),this.node=new AudioWorkletNode(this.srcNode.context,`${r}-processor`,{parameterData:{}})}this.node.port.onmessage=t=>this.handleNodePortMessage(t),this.srcNode.connect(this.node).connect(this.srcNode.context.destination)}handleNodePortMessage(r){if(r.data.type==="message"&&console.log(r.data.message),r.data.type==="peaks"){let{peaks:t}=r.data;for(let i=0;i<this.tempPeaks.length;i+=1)t.length>i?this.tempPeaks[i]=t[i]:this.tempPeaks[i]=0;t.length<this.channelCount&&this.tempPeaks.fill(0,t.length);for(let i=0;i<t.length;i+=1)t[i]>this.heldPeaks[i]&&(this.heldPeaks[i]=t[i],this.peakHoldTimeouts[i]&&clearTimeout(this.peakHoldTimeouts[i]),this.config.peakHoldDuration&&(this.peakHoldTimeouts[i]=window.setTimeout(()=>{this.clearPeak(i)},this.config.peakHoldDuration)))}}paintMeter(){let{dbRangeMin:r,dbRangeMax:t,vertical:i}=this.config;this.bars&&this.bars.forEach((o,h)=>{let s=function(f,u,m,a){let l=Math.floor(100*(m-f)/(m-u));return l>100&&(l=100),l<0&&(l=0),a?`inset(${l}% 0 0)`:`inset(0 ${l}% 0 0)`}(Q(this.tempPeaks[h]),r,t,i);o.style.clipPath=s}),this.peakLabels&&this.peakLabels.forEach((o,h)=>{if(this.heldPeaks[h]===0)o.textContent="-\u221E";else{let s=Q(this.heldPeaks[h]);o.textContent=s.toFixed(1)}}),this.animationRequestId=window.requestAnimationFrame(this.paintMeter.bind(this))}clearPeak(r){this.heldPeaks[r]=this.tempPeaks[r]}clearPeaks(){for(let r=0;r<this.heldPeaks.length;r+=1)this.clearPeak(r)}getPeaks(){return{current:this.tempPeaks,maxes:this.heldPeaks,currentDB:this.tempPeaks.map(Q),maxesDB:this.heldPeaks.map(Q)}}cleanup(){this.node&&this.node.disconnect(),this.parent&&(this.parent.removeEventListener("click",this.clearPeaks.bind(this)),this.animationRequestId!==void 0&&window.cancelAnimationFrame(this.animationRequestId),this.parent.remove())}}});function U(r){return{videoUrl:r.videoUrl,loglevel:r.loglevel,playState:r.playState.buf(),videoBufferFull:r.videoBufferFull.buf(),audioBufferFull:r.audioBufferFull.buf(),videoDecoderShouldBeDead:r.videoDecoderShouldBeDead.buf(),audioDecoderShouldBeDead:r.audioDecoderShouldBeDead.buf()}}var y;(function(s){s[s.STOPPED=-1]="STOPPED",s[s.PLAYING=0]="PLAYING",s[s.PAUSED=1]="PAUSED",s[s.BUFFERING=2]="BUFFERING",s[s.SEEKING=3]="SEEKING"})(y||(y={}));var D,re=class{constructor(t){c(this,D,void 0);let i=new SharedArrayBuffer(4);n(this,D,new Int32Array(i)),e(this,D)[0]=t}static fromBuffer(t){let i=-1,o=new re(i);return n(o,D,t),o}load(){return Atomics.load(e(this,D),0)}store(t){Atomics.store(e(this,D),0,t),Atomics.notify(e(this,D),0)}buf(){return e(this,D)}},ie=re;D=new WeakMap;var A,H,j,R=class{constructor(t){c(this,A,void 0);let i=new SharedArrayBuffer(4);n(this,A,new Int32Array(i)),e(this,A)[0]=t?e(R,H):e(R,j)}static fromBuffer(t){let i=!1,o=new R(i);return n(o,A,t),o}load(){return Atomics.load(e(this,A),0)===e(R,H)}store(t){Atomics.store(e(this,A),0,t?e(R,H):e(R,j)),Atomics.notify(e(this,A),0)}buf(){return e(this,A)}sab(){return e(this,A).buffer}},V=R;A=new WeakMap,H=new WeakMap,j=new WeakMap,c(V,H,1),c(V,j,0);var ue="webvideo-audio-worklet",me="./player/audio/rendererWorker/worker.js",fe="webvideo-audio-decoder-worker",pe="./player/audio/decoderWorker/worker.js",ye="webvideo-video-decoder-worker",ge="./player/video/decoderWorker/worker.js";var g;(function(s){s[s.TRACE=0]="TRACE",s[s.DEBUG=1]="DEBUG",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR"})(g||(g={}));var I;(function(a){a.BLACK="[30m",a.RED="[31m",a.GREEN="[32m",a.YELLOW="[33m",a.BLUE="[34m",a.MAGENTA="[35m",a.CYAN="[36m",a.WHITE="[37m",a.NONE=""})(I||(I={}));function be(r,t){if(t===I.NONE)return r;{let i="[0m";return t+r+i}}function we(r){return r?`[${r}]`:""}var Se={loglevel:3};function Ae(r){typeof self!="undefined"&&(self.__wv_global_loglevel=r),Se.loglevel=r}function ke(){return typeof self!="undefined"?self.__wv_global_loglevel:Se.loglevel}function Y(r,t,i){if(r<ke())return;let o=console.log,h=I.NONE;switch(r){case 0:{o=console.log,h=I.WHITE;break}case 1:{o=console.debug,h=I.CYAN;break}case 2:{o=console.info,h=I.GREEN;break}case 3:{o=console.warn;break}case 4:{o=console.error;break}}o(be([we(i),t].filter(s=>s).join(" "),h))}function De(r,t){Y(0,r,t)}function Pe(r,t){Y(1,r,t)}function We(r,t){Y(2,r,t)}function Me(r,t){Y(3,r,t)}function xe(r,t){Y(4,r,t)}var $={setLevel:Ae,trace:De,debug:Pe,info:We,warn:Me,error:xe};var P,E,z,oe=class{constructor(t){c(this,P,void 0);c(this,E,[]);c(this,z,void 0);n(this,P,new Worker(ge,{type:"module",name:ye})),n(this,z,t.maxVideoFrameLength)}init(t){return new Promise(i=>{e(this,P).onmessage=o=>{switch(o.data.msg){case"VideoDecoder_sendVideoStreamInfo":{i(o.data.videoStream);break}case"VideoDecoder_sendVideoFrame":{this.push(t,o.data.frame);break}}},e(this,P).postMessage({msg:"Main_requestVideoDecoderStart",sharedState:U(t)})})}async uninit(t){return new Promise(i=>{for(e(this,P).onmessage=o=>{switch(o.data.msg){case"VideoDecoder_notifyClosed":{e(this,P).terminate(),i();break}}};e(this,E).length>0;)this.pop(t);t.videoDecoderShouldBeDead.store(!0),e(this,P).postMessage({msg:"Main_requestVideoDecoderClose"})})}start(){e(this,P).postMessage({msg:"Main_requestVideoDecoderDecode"})}dequeue(t,i){for(;e(this,E).length>0;){if(!e(this,E)[0].timestamp){this.pop(t);continue}let o=e(this,E)[0].timestamp-i*1e6;if(o<-.1*1e6){$.trace("chooseFrame(): frame dropped","WVVideoDecoderWorkerFront"),this.pop(t);continue}else return o>.1*1e6?($.trace("chooseFrame(): frame too fast","WVVideoDecoderWorkerFront"),null):e(this,E)[0]}return null}front(){return e(this,E).length>0?e(this,E)[0]:null}push(t,i){e(this,E).push(i),e(this,E).length>e(this,z)&&t.videoBufferFull.store(!0)}pop(t){let i=e(this,E).shift();i&&(i.close(),e(this,E).length<e(this,z)&&t.videoBufferFull.store(!1))}};P=new WeakMap,E=new WeakMap,z=new WeakMap;var W,se=class{constructor(){c(this,W,void 0);n(this,W,new Worker(pe,{type:"module",name:fe}))}init(t){return new Promise(i=>{e(this,W).onmessage=o=>{switch(o.data.msg){case"AudioDecoder_sendAudioStreamInfo":{i(o.data.audioStream);break}}},e(this,W).postMessage({msg:"Main_requestAudioDecoderStart",sharedState:U(t)})})}async uninit(t){return new Promise(i=>{e(this,W).onmessage=o=>{switch(o.data.msg){case"AudioDecoder_notifyClosed":{e(this,W).terminate(),i();break}}},t.audioDecoderShouldBeDead.store(!0),t.audioBufferFull.store(!1),e(this,W).postMessage({msg:"Main_requestAudioDecoderClose"})})}start(t){e(this,W).postMessage({msg:"Main_requestAudioDecoderDecode"},[t])}};W=new WeakMap;var F,q,ae=class{constructor(t,i){c(this,F,void 0);c(this,q,void 0);n(this,F,t),e(this,F).width=i.video.width,e(this,F).height=i.video.height,n(this,q,t.getContext("2d"))}draw(t){e(this,q).drawImage(t,0,0,t.displayWidth,t.displayHeight)}clear(){e(this,q).clearRect(0,0,e(this,F).width,e(this,F).height)}};F=new WeakMap,q=new WeakMap;var Fe=Ee(),v,x,G,C,le=class{constructor(t){c(this,v,void 0);c(this,x,void 0);c(this,G,void 0);c(this,C,void 0);let i=44100;t!==null&&(i=t.audio.sampleRate),n(this,v,new AudioContext({sampleRate:i,latencyHint:"playback"})),e(this,v).suspend()}async init(t,i){await e(this,v).audioWorklet.addModule(me);let o=2;if(i!==null&&(o=i.audio.nbChannels),n(this,x,new AudioWorkletNode(e(this,v),ue,{processorOptions:{sharedState:U(t)},outputChannelCount:[o]})),n(this,G,new GainNode(e(this,v),{gain:.5})),e(this,x).connect(e(this,G)).connect(e(this,v).destination),i!==null){var h=document.getElementById("peak-meter");let s={vertical:!0};n(this,C,new Fe.WebAudioPeakMeter(e(this,x),h,s))}else n(this,C,null);return e(this,x).port}async start(){await e(this,v).resume()}async pause(){await e(this,v).suspend()}async close(){e(this,C)&&e(this,C).cleanup(),e(this,G)?.disconnect(),e(this,x)?.disconnect(),e(this,x)?.port.close(),await e(this,v).close()}currentTime(){return Math.max(e(this,v).currentTime-e(this,v).baseLatency,0)}};v=new WeakMap,x=new WeakMap,G=new WeakMap,C=new WeakMap;var K,d,B,b,k,ee,O,w,_,T,Z=class{constructor(t){c(this,K,void 0);c(this,d,void 0);c(this,B,void 0);c(this,b,void 0);c(this,k,void 0);c(this,ee,10);c(this,O,void 0);c(this,w,void 0);c(this,_,void 0);c(this,T,!1);n(this,K,t),n(this,d,{videoUrl:t.videoUrl,loglevel:t.loglevel??g.WARN,playState:new ie(y.STOPPED),audioBufferFull:new V(!1),videoBufferFull:new V(!1),videoDecoderShouldBeDead:new V(!1),audioDecoderShouldBeDead:new V(!1),enableAudio:t.enableAudio}),$.setLevel(e(this,d).loglevel)}async setUrl(t,i){return await this.unload(),e(this,d).videoUrl=t,this.load(i)}async load(t){if(e(this,T))throw Error("load() is already called");n(this,T,!0),e(this,d).videoDecoderShouldBeDead.store(!1),e(this,d).audioDecoderShouldBeDead.store(!1),n(this,k,new oe({maxVideoFrameLength:e(this,ee)})),e(this,d).enableAudio&&n(this,O,new se),e(this,d).playState.store(y.BUFFERING),await t?.onStart?.();{n(this,w,await e(this,k).init(e(this,d))),e(this,d).enableAudio?n(this,_,await e(this,O).init(e(this,d))):n(this,_,null),n(this,B,new ae(e(this,K).canvasElem,e(this,w))),n(this,b,new le(e(this,_)));let i=await e(this,b).init(e(this,d),e(this,_));e(this,k).start(),e(this,d).enableAudio&&e(this,O).start(i),await new Promise(h=>{let s=e(this,d);requestAnimationFrame(function f(){if(s.playState.load()!==y.BUFFERING)return h(0);let u=s.videoBufferFull.load();if(s.enableAudio&&(u=u&&s.audioBufferFull.load()),u)return h(0);requestAnimationFrame(f)})});let o=e(this,k).front();o&&e(this,B).draw(o)}await t?.onEnd?.(),e(this,d).playState.store(y.PAUSED)}async unload(t){!e(this,T)||(n(this,T,!1),e(this,d).playState.store(y.STOPPED),await t?.onStart?.(),e(this,B)?.clear(),await e(this,b)?.close(),await e(this,k).uninit(e(this,d)),e(this,d).enableAudio&&await e(this,O).uninit(e(this,d)),e(this,d).videoBufferFull.store(!1),e(this,d).audioBufferFull.store(!1),n(this,k,null),n(this,O,null),await t?.onEnd?.())}loadCalled(){return e(this,T)}playState(){return e(this,d).playState.load()}canPlay(){return e(this,d).enableAudio?e(this,d).audioBufferFull.load():!0}async play(){if(!e(this,b))throw Error("WVAudioRenderer is undefined");e(this,d).playState.store(y.PLAYING),await e(this,b).start(),this.mainLoop()}async pause(){if(!e(this,b))throw Error("WVAudioRenderer is undefined");e(this,d).playState.store(y.PAUSED),await e(this,b).pause()}async mainLoop(){if(e(this,d).playState.load()!==y.PLAYING)return;let t=!!e(this,B);if(e(this,d).enableAudio&&(t=t&&!!e(this,b)),!t){$.error("Renderers are not initialized yet","WVPlayer");return}let i=e(this,b).currentTime(),o=e(this,k).dequeue(e(this,d),i);o&&(e(this,B).draw(o),e(this,k).pop(e(this,d))),i>=this.length()&&(await this.pause(),await this.onEOS()),requestAnimationFrame(this.mainLoop.bind(this))}duration(){return e(this,w).duration}timescale(){return e(this,w).timescale}length(){return e(this,w).duration/e(this,w).timescale}lengthMS(){return e(this,w).duration/e(this,w).timescale*1e3}bitrate(){return e(this,w).bitrate}};K=new WeakMap,d=new WeakMap,B=new WeakMap,b=new WeakMap,k=new WeakMap,ee=new WeakMap,O=new WeakMap,w=new WeakMap,_=new WeakMap,T=new WeakMap,Z.LogLevel=g;var M,de=[["./assets/TearsOfSteel.mp4","[Excerpt] \u201CTears of Steel\u201D by Blender Foundation (CC BY 3.0)"],["./assets/ElephantsDream.mp4","[Excerpt] \u201CElephants Dream\u201D by Blender Foundation (CC BY)"]],N;(function(i){i.FONTAWESOME_PLAY="&#xf04b;",i.FONTAWESOME_PAUSE="&#xf04c;"})(N||(N={}));function Be(r){r.style.display=""}function Oe(r){r.style.display="none"}function Te(r){r.style.display=""}function Ie(r){r.style.display="none"}function te(r,t){t.style.opacity=r?"0":"1"}function X(r,t){t.innerHTML=r}window.addEventListener("beforeunload",r=>{function t(i){let o=new Date().getTime();for(;new Date().getTime()-o<i;);}M?.loadCalled()&&M?.unload(),r.preventDefault(),r.returnValue=""});window.addEventListener("load",async()=>{let r=document.querySelector("select#video_select"),t=document.querySelector("#play_btn_wrapper"),i=document.querySelector("#loader_wrapper"),o=document.querySelector("#play_btn"),h=document.querySelector("#title_area h3"),s=document.querySelector("#title_area"),f=de.length,u=0,a=new URL(window.location.href).searchParams,l=!0;if(a.get("disable-audio")!==null){l=!1;var S=document.getElementById("peak-meter");S.style.display="none"}M=new Z({canvasElem:document.querySelector("#monitor"),enableAudio:l}),M.onEOS=async()=>{u++,await p()},X(N.FONTAWESOME_PLAY,o),o.addEventListener("click",async()=>{switch(M.playState()){case y.PAUSED:{M.canPlay()&&(await M.play(),te(!0,t),X(N.FONTAWESOME_PAUSE,o));break}case y.PLAYING:{await M.pause(),te(!1,t),X(N.FONTAWESOME_PLAY,o);break}case y.STOPPED:await p()}}),s.addEventListener("click",async()=>{u++,await p()});async function p(){u>=f&&(u=0);let L=new URL(de[u][0],location.origin).href;await M.setUrl(L,{onStart:async()=>{Ie(t),Be(i)},onEnd:async()=>{Oe(i),Te(t),te(!1,t),X(N.FONTAWESOME_PLAY,o)}}),await M.play(),te(!0,t),X(N.FONTAWESOME_PAUSE,o),h.textContent=de[u][1]}await p()});
