var ee=(r,t,o)=>{if(!t.has(r))throw TypeError("Cannot "+o)};var e=(r,t,o)=>(ee(r,t,"read from private field"),o?o.call(r):t.get(r)),n=(r,t,o)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,o)},s=(r,t,o,a)=>(ee(r,t,"write to private field"),a?a.call(r,o):t.set(r,o),o);function G(r){return{videoUrl:r.videoUrl,loglevel:r.loglevel,playState:r.playState.buf(),videoBufferFull:r.videoBufferFull.buf(),audioBufferFull:r.audioBufferFull.buf(),videoDecoderShouldBeDead:r.videoDecoderShouldBeDead.buf(),audioDecoderShouldBeDead:r.audioDecoderShouldBeDead.buf()}}var m;(function(i){i[i.STOPPED=-1]="STOPPED",i[i.PLAYING=0]="PLAYING",i[i.PAUSED=1]="PAUSED",i[i.BUFFERING=2]="BUFFERING",i[i.SEEKING=3]="SEEKING"})(m||(m={}));var E,z=class{constructor(t){n(this,E,void 0);let o=new SharedArrayBuffer(4);s(this,E,new Int32Array(o)),e(this,E)[0]=t}static fromBuffer(t){let o=-1,a=new z(o);return s(a,E,t),a}load(){return Atomics.load(e(this,E),0)}store(t){Atomics.store(e(this,E),0,t),Atomics.notify(e(this,E),0)}buf(){return e(this,E)}},Y=z;E=new WeakMap;var p,B,N,D=class{constructor(t){n(this,p,void 0);let o=new SharedArrayBuffer(4);s(this,p,new Int32Array(o)),e(this,p)[0]=t?e(D,B):e(D,N)}static fromBuffer(t){let o=!1,a=new D(o);return s(a,p,t),a}load(){return Atomics.load(e(this,p),0)===e(D,B)}store(t){Atomics.store(e(this,p),0,t?e(D,B):e(D,N)),Atomics.notify(e(this,p),0)}buf(){return e(this,p)}sab(){return e(this,p).buffer}},W=D;p=new WeakMap,B=new WeakMap,N=new WeakMap,n(W,B,1),n(W,N,0);var te="webvideo-audio-worklet",re="./player/audio/rendererWorker/worker.js";var oe="webvideo-video-decoder-worker",ae="./player/video/decoderWorker/worker.js";var c;(function(i){i[i.TRACE=0]="TRACE",i[i.DEBUG=1]="DEBUG",i[i.INFO=2]="INFO",i[i.WARN=3]="WARN",i[i.ERROR=4]="ERROR"})(c||(c={}));var R;(function(d){d.BLACK="[30m",d.RED="[31m",d.GREEN="[32m",d.YELLOW="[33m",d.BLUE="[34m",d.MAGENTA="[35m",d.CYAN="[36m",d.WHITE="[37m",d.NONE=""})(R||(R={}));function ue(r,t){if(t===R.NONE)return r;{let o="[0m";return t+r+o}}function ce(r){return r?`[${r}]`:""}var ie={loglevel:3};function me(r){typeof self!="undefined"&&(self.__wv_global_loglevel=r),ie.loglevel=r}function fe(){return typeof self!="undefined"?self.__wv_global_loglevel:ie.loglevel}function L(r,t,o){if(r<fe())return;let a=console.log,S=R.NONE;switch(r){case 0:{a=console.log,S=R.WHITE;break}case 1:{a=console.debug,S=R.CYAN;break}case 2:{a=console.info,S=R.GREEN;break}case 3:{a=console.warn;break}case 4:{a=console.error;break}}a(ue([ce(o),t].filter(i=>i).join(" "),S))}function he(r,t){L(0,r,t)}function pe(r,t){L(1,r,t)}function Se(r,t){L(2,r,t)}function Ee(r,t){L(3,r,t)}function ye(r,t){L(4,r,t)}var P={setLevel:me,trace:he,debug:pe,info:Se,warn:Ee,error:ye};var y,f,T,K=class{constructor(t){n(this,y,void 0);n(this,f,[]);n(this,T,void 0);s(this,y,new Worker(ae,{type:"module",name:oe})),s(this,T,t.maxVideoFrameLength)}init(t){return new Promise(o=>{e(this,y).onmessage=a=>{switch(a.data.msg){case"VideoDecoder_sendVideoStreamInfo":{o(a.data.videoStream);break}case"VideoDecoder_sendVideoFrame":{this.push(t,a.data.frame);break}}},e(this,y).postMessage({msg:"Main_requestVideoDecoderStart",sharedState:G(t)})})}async uninit(t){return new Promise(o=>{for(e(this,y).onmessage=a=>{switch(a.data.msg){case"VideoDecoder_notifyClosed":{e(this,y).terminate(),o();break}}};e(this,f).length>0;)this.pop(t);t.videoDecoderShouldBeDead.store(!0),e(this,y).postMessage({msg:"Main_requestVideoDecoderClose"})})}start(){e(this,y).postMessage({msg:"Main_requestVideoDecoderDecode"})}dequeue(t,o){for(;e(this,f).length>0;){if(!e(this,f)[0].timestamp){this.pop(t);continue}let a=e(this,f)[0].timestamp-o*1e6;if(a<-.1*1e6){P.trace("chooseFrame(): frame dropped","WVVideoDecoderWorkerFront"),this.pop(t);continue}else return a>.1*1e6?(P.trace("chooseFrame(): frame too fast","WVVideoDecoderWorkerFront"),null):e(this,f)[0]}return null}front(){return e(this,f).length>0?e(this,f)[0]:null}push(t,o){e(this,f).push(o),e(this,f).length>e(this,T)&&t.videoBufferFull.store(!0)}pop(t){let o=e(this,f).shift();o&&(o.close(),e(this,f).length<e(this,T)&&t.videoBufferFull.store(!1))}};y=new WeakMap,f=new WeakMap,T=new WeakMap;var w,M,j=class{constructor(t,o){n(this,w,void 0);n(this,M,void 0);s(this,w,t),e(this,w).width=o.video.width,e(this,w).height=o.video.height,s(this,M,t.getContext("2d"))}draw(t){e(this,M).drawImage(t,0,0,t.displayWidth,t.displayHeight)}clear(){e(this,M).clearRect(0,0,e(this,w).width,e(this,w).height)}};w=new WeakMap,M=new WeakMap;var h,V,_,$=class{constructor(t){n(this,h,void 0);n(this,V,void 0);n(this,_,void 0);s(this,h,new AudioContext({sampleRate:44100,latencyHint:"playback"})),e(this,h).suspend()}async init(t,o){return await e(this,h).audioWorklet.addModule(re),s(this,V,new AudioWorkletNode(e(this,h),te,{processorOptions:{sharedState:G(t)},outputChannelCount:[o.audio.nbChannels]})),s(this,_,new GainNode(e(this,h),{gain:.5})),e(this,V).connect(e(this,_)).connect(e(this,h).destination),e(this,V).port}async start(){await e(this,h).resume()}async pause(){await e(this,h).suspend()}async close(){e(this,_)?.disconnect(),e(this,V)?.disconnect(),e(this,V)?.port.close(),await e(this,h).close()}currentTime(){return Math.max(e(this,h).currentTime-e(this,h).baseLatency,0)}};h=new WeakMap,V=new WeakMap,_=new WeakMap;var k,l,g,v,A,q,J,U,Q,b,x=class{constructor(t){n(this,k,void 0);n(this,l,void 0);n(this,g,void 0);n(this,v,void 0);n(this,A,void 0);n(this,q,10);n(this,J,void 0);n(this,U,void 0);n(this,Q,void 0);n(this,b,!1);s(this,k,t),s(this,l,{videoUrl:t.videoUrl,loglevel:t.loglevel??c.WARN,playState:new Y(m.STOPPED),audioBufferFull:new W(!1),videoBufferFull:new W(!1),videoDecoderShouldBeDead:new W(!1),audioDecoderShouldBeDead:new W(!1)}),P.setLevel(e(this,l).loglevel),s(this,A,new K({maxVideoFrameLength:e(this,q)}))}async load(t){if(e(this,b))throw Error("load() is already called");s(this,b,!0),e(this,l).playState.store(m.BUFFERING),await t?.onStart?.();{s(this,U,await e(this,A).init(e(this,l))),s(this,g,new j(e(this,k).canvasElem,e(this,U))),s(this,v,new $(null)),e(this,A).start(),await new Promise(a=>{let S=e(this,l);requestAnimationFrame(function i(){if(S.playState.load()!==m.BUFFERING||S.videoBufferFull.load())return a(0);requestAnimationFrame(i)})});let o=e(this,A).front();o&&e(this,g).draw(o)}await t?.onEnd?.(),e(this,l).playState.store(m.PAUSED)}async unload(t){if(!e(this,b))throw Error("load() is not called called");s(this,b,!1),e(this,l).playState.store(m.STOPPED),await t?.onStart?.(),e(this,g)?.clear(),await e(this,v)?.close(),await e(this,A).uninit(e(this,l)),await t?.onEnd?.()}loadCalled(){return e(this,b)}playState(){return e(this,l).playState.load()}canPlay(){return!0}async play(){if(!e(this,v))throw Error("WVAudioRenderer is undefined");e(this,l).playState.store(m.PLAYING),await e(this,v).start(),this.mainLoop()}async pause(){if(!e(this,v))throw Error("WVAudioRenderer is undefined");e(this,l).playState.store(m.PAUSED),await e(this,v).pause()}async mainLoop(){if(e(this,l).playState.load()!==m.PLAYING)return;if(!e(this,g)){P.error("Renderers are not initialized yet","WVPlayer");return}let t=e(this,v).currentTime(),o=e(this,A).dequeue(e(this,l),t);o&&(e(this,g).draw(o),e(this,A).pop(e(this,l))),requestAnimationFrame(this.mainLoop.bind(this))}};k=new WeakMap,l=new WeakMap,g=new WeakMap,v=new WeakMap,A=new WeakMap,q=new WeakMap,J=new WeakMap,U=new WeakMap,Q=new WeakMap,b=new WeakMap,x.LogLevel=c;var u,H=[["./assets/TearsOfSteel.mp4","[Excerpt] \u201CTears of Steel\u201D by Blender Foundation (CC BY 3.0)"],["./assets/ElephantsDream.mp4","[Excerpt] \u201CElephants Dream\u201D by Blender Foundation (CC BY)"]],F;(function(o){o.FONTAWESOME_PLAY="&#xf04b;",o.FONTAWESOME_PAUSE="&#xf04c;"})(F||(F={}));function X(r){r.style.display=""}function ne(r){r.style.display="none"}function se(r){r.style.display=""}function Z(r){r.style.display="none"}function C(r,t){t.style.opacity=r?"0":"1"}function I(r,t){t.innerHTML=r}window.addEventListener("beforeunload",r=>{function t(o){let a=new Date().getTime();for(;new Date().getTime()-a<o;);}u?.loadCalled()&&u?.unload(),r.preventDefault(),r.returnValue=""});window.addEventListener("load",async()=>{let r=document.querySelector("select#video_select"),t=document.querySelector("#play_btn_wrapper"),o=document.querySelector("#loader_wrapper"),a=document.querySelector("#play_btn"),S=document.querySelector("#title_area h3"),i=document.querySelector("#title_area"),de=H.length,O=1;I(F.FONTAWESOME_PLAY,a),a.addEventListener("click",async()=>{switch(u||(u?.loadCalled()&&await u?.unload({onEnd:async()=>{Z(t),X(o)}}),u=new x({videoUrl:new URL(H[O][0],location.origin).href,canvasElem:document.querySelector("#monitor")}),S.textContent=H[O][1],await u.load({onStart:async()=>{Z(t),X(o)},onEnd:async()=>{ne(o),se(t),C(!1,t),I(F.FONTAWESOME_PLAY,a)}})),u.playState()){case m.PAUSED:{u.canPlay()&&(u.play(),C(!0,t),I(F.FONTAWESOME_PAUSE,a));break}case m.PLAYING:{u.pause(),C(!1,t),I(F.FONTAWESOME_PLAY,a);break}}}),i.addEventListener("click",async()=>{O++,O>de-1&&(O=0),le(O)});async function le(d=0){u&&u.unload(),u=new x({videoUrl:new URL(H[d][0],location.origin).href,canvasElem:document.querySelector("#monitor")}),await u.load({onStart:async()=>{Z(t),X(o)},onEnd:async()=>{ne(o),se(t),C(!1,t),I(F.FONTAWESOME_PLAY,a)}}),u.canPlay()&&(u.play(),C(!0,t),I(F.FONTAWESOME_PAUSE,a),S.textContent=H[d][1])}});
