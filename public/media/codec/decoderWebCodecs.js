var v=(i,e,o)=>{if(!e.has(i))throw TypeError("Cannot "+o)};var r=(i,e,o)=>(v(i,e,"read from private field"),o?o.call(i):e.get(i)),l=(i,e,o)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,o)},f=(i,e,o,d)=>(v(i,e,"write to private field"),d?d.call(i,o):e.set(i,o),o);function M(i){return new Promise(e=>{setTimeout(()=>{e()},i)})}var c;(function(s){s[s.TRACE=0]="TRACE",s[s.DEBUG=1]="DEBUG",s[s.INFO=2]="INFO",s[s.WARN=3]="WARN",s[s.ERROR=4]="ERROR"})(c||(c={}));var p;(function(t){t.BLACK="[30m",t.RED="[31m",t.GREEN="[32m",t.YELLOW="[33m",t.BLUE="[34m",t.MAGENTA="[35m",t.CYAN="[36m",t.WHITE="[37m",t.NONE=""})(p||(p={}));function C(i,e){if(e===p.NONE)return i;{let o="[0m";return e+i+o}}function R(i){return i?`[${i}]`:""}var A={loglevel:3};function I(i){typeof self!="undefined"&&(self.__wv_global_loglevel=i),A.loglevel=i}function N(){return typeof self!="undefined"?self.__wv_global_loglevel:A.loglevel}function w(i,e,o){if(i<N())return;let d=console.log,n=p.NONE;switch(i){case 0:{d=console.log,n=p.WHITE;break}case 1:{d=console.debug,n=p.CYAN;break}case 2:{d=console.info,n=p.GREEN;break}case 3:{d=console.warn;break}case 4:{d=console.error;break}}d(C([R(o),e].filter(s=>s).join(" "),n))}function O(i,e){w(0,i,e)}function k(i,e){w(1,i,e)}function P(i,e){w(2,i,e)}function S(i,e){w(3,i,e)}function x(i,e){w(4,i,e)}var u={setLevel:I,trace:O,debug:k,info:P,warn:S,error:x};var m,D,W,E=class{constructor(e){l(this,m,void 0);l(this,D,null);l(this,W,void 0);f(this,m,e),f(this,W,e instanceof VideoFrame?"video":"audio")}async load(){if(r(this,W)==="video"){let e=r(this,m);f(this,D,{timestamp:r(this,m).timestamp,duration:r(this,m).duration,video:{colorSpace:e.colorSpace,format:e.format,codedWidth:e.codedWidth,codedHeight:e.codedHeight}})}else{let e=r(this,m),o=[];for(let d=0;d<e.numberOfChannels;d++){let n=new Float32Array(e.numberOfFrames);e.copyTo(n,{planeIndex:d,format:"f32-planar"}),o.push(n)}f(this,D,{timestamp:r(this,m).timestamp,duration:r(this,m).duration,audio:{bufs:o,format:e.format,nbChannels:e.numberOfChannels,sampleRate:e.sampleRate}})}}type(){return r(this,W)}info(){return r(this,D)}close(){r(this,m).close()}nativeFrame(){return r(this,m)}};m=new WeakMap,D=new WeakMap,W=new WeakMap;function F(i,e){return i[e]*1e6/i.timescale}function G(i){return new EncodedVideoChunk({type:i.hasKeyframe?"key":"delta",timestamp:F(i,"cts"),duration:F(i,"duration"),data:i.data})}function T(i){return new EncodedAudioChunk({type:i.hasKeyframe?"key":"delta",timestamp:F(i,"cts"),duration:F(i,"duration"),data:i.data})}async function _(i){let e={codec:i.codec,description:i.video.avcDescription,hardwareAcceleration:"prefer-hardware"};u.debug("Trying hardware decoding...","WebCodecsMediaDecoder");let o=await VideoDecoder.isConfigSupported(e);if(!o.supported)u.debug("Codec not supported","WebCodecsMediaDecoder"),u.debug(o,"WebCodecsMediaDecoder"),u.debug("Trying software decoding...","WebCodecsMediaDecoder");else return u.debug("Using hardware decoding","WebCodecsMediaDecoder"),e;return e.hardwareAcceleration="prefer-software",o=await VideoDecoder.isConfigSupported(e),o.supported?(u.debug("Using software decoding","WebCodecsMediaDecoder"),e):(u.debug("Codec not supported","WebCodecsMediaDecoder"),u.debug(o,"WebCodecsMediaDecoder"),null)}async function B(i,e){let o=await _(i);if(!o)return null;let d=new VideoDecoder({output:e,error:n=>u.error(n,"WebCodecsMediaDecoder")});return d.configure(o),d}async function U(i,e){let o=new AudioDecoder({output:e,error:s=>u.error(s,"WebCodecsMediaDecoder")}),d={codec:i.codec==="mp4a.6b"?"mp3":i.codec.toLowerCase(),sampleRate:i.audio.sampleRate,numberOfChannels:i.audio.nbChannels},n=await AudioDecoder.isConfigSupported(d);return n.supported?(o.configure(d),o):(u.error("Codec not supported","WebCodecsMediaDecoder"),u.error(n,"WebCodecsMediaDecoder"),null)}async function H(i,e){return i.type==="video"?await B(i,e):await U(i,e)}var b,y,a,h,V,g,z=class{constructor(e){l(this,b,void 0);l(this,y,null);l(this,a,null);l(this,h,[]);l(this,V,e=>{e.close()});l(this,g,!1);f(this,b,e)}async open(e,o){f(this,y,await r(this,b).loadFile(e)),await this.flushDecoders(),f(this,V,d=>{r(this,h).push(d)});for(let d of r(this,y).streams)if(d.type===o){let n=await H(d,this.onOutput.bind(this));if(n){f(this,a,n);break}}return r(this,y)}onOutput(e){r(this,V).call(this,e)}async destroy(){if(f(this,g,!0),r(this,b).destroy(),f(this,V,e=>{e.close()}),this.clearFrames(),r(this,a)){for(await r(this,a).flush();r(this,a).decodeQueueSize>0;)await M(4);r(this,a).close()}}async*decode(e){if(!r(this,a))throw Error("WebCodecsMediaDecoder: No decoder exists");for await(let o of r(this,b).demux(e)){if(r(this,g))return;if(o.eof)break;yield*this.flushFrames(),!r(this,g)&&o.pkt&&o.pkt.data&&r(this,a).state==="configured"&&r(this,a).decode(r(this,a)instanceof VideoDecoder?G(o.pkt):T(o.pkt)),yield{frame:null,eof:!1}}for(;r(this,a).decodeQueueSize>0;)yield*this.flushFrames(),await M(4);await r(this,a).flush(),yield*this.flushFrames(),yield{frame:null,eof:!0}}async*flushFrames(){for(;r(this,h).length>0;){let e=new E(r(this,h).shift());await e.load(),yield{frame:e,eof:!1}}}clearFrames(){for(let e of r(this,h))e.close();f(this,h,[])}async flushDecoders(){r(this,a)&&await r(this,a).flush()}};b=new WeakMap,y=new WeakMap,a=new WeakMap,h=new WeakMap,V=new WeakMap,g=new WeakMap;export{z as WebCodecsMediaDecoder};
