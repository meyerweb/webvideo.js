var J=(r,t,o)=>{if(!t.has(r))throw TypeError("Cannot "+o)};var e=(r,t,o)=>(J(r,t,"read from private field"),o?o.call(r):t.get(r)),n=(r,t,o)=>{if(t.has(r))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(r):t.set(r,o)},s=(r,t,o,i)=>(J(r,t,"write to private field"),i?i.call(r,o):t.set(r,o),o);function k(r){return{videoUrl:r.videoUrl,loglevel:r.loglevel,playState:r.playState.buf(),videoBufferFull:r.videoBufferFull.buf(),audioBufferFull:r.audioBufferFull.buf(),videoDecoderShouldBeDead:r.videoDecoderShouldBeDead.buf(),audioDecoderShouldBeDead:r.audioDecoderShouldBeDead.buf()}}var c;(function(a){a[a.STOPPED=-1]="STOPPED",a[a.PLAYING=0]="PLAYING",a[a.PAUSED=1]="PAUSED",a[a.BUFFERING=2]="BUFFERING",a[a.SEEKING=3]="SEEKING"})(c||(c={}));var S,C=class{constructor(t){n(this,S,void 0);let o=new SharedArrayBuffer(4);s(this,S,new Int32Array(o)),e(this,S)[0]=t}static fromBuffer(t){let o=-1,i=new C(o);return s(i,S,t),i}load(){return Atomics.load(e(this,S),0)}store(t){Atomics.store(e(this,S),0,t),Atomics.notify(e(this,S),0)}buf(){return e(this,S)}},G=C;S=new WeakMap;var f,R,M,D=class{constructor(t){n(this,f,void 0);let o=new SharedArrayBuffer(4);s(this,f,new Int32Array(o)),e(this,f)[0]=t?e(D,R):e(D,M)}static fromBuffer(t){let o=!1,i=new D(o);return s(i,f,t),i}load(){return Atomics.load(e(this,f),0)===e(D,R)}store(t){Atomics.store(e(this,f),0,t?e(D,R):e(D,M)),Atomics.notify(e(this,f),0)}buf(){return e(this,f)}sab(){return e(this,f).buffer}},A=D;f=new WeakMap,R=new WeakMap,M=new WeakMap,n(A,R,1),n(A,M,0);var Q="webvideo-audio-worklet",X="./player/audio/rendererWorker/worker.js";var Z="webvideo-video-decoder-worker",ee="./player/video/decoderWorker/worker.js";var u;(function(a){a[a.TRACE=0]="TRACE",a[a.DEBUG=1]="DEBUG",a[a.INFO=2]="INFO",a[a.WARN=3]="WARN",a[a.ERROR=4]="ERROR"})(u||(u={}));var F;(function(d){d.BLACK="[30m",d.RED="[31m",d.GREEN="[32m",d.YELLOW="[33m",d.BLUE="[34m",d.MAGENTA="[35m",d.CYAN="[36m",d.WHITE="[37m",d.NONE=""})(F||(F={}));function ie(r,t){if(t===F.NONE)return r;{let o="[0m";return t+r+o}}function ae(r){return r?`[${r}]`:""}var te={loglevel:3};function ne(r){typeof self!="undefined"&&(self.__wv_global_loglevel=r),te.loglevel=r}function se(){return typeof self!="undefined"?self.__wv_global_loglevel:te.loglevel}function _(r,t,o){if(r<se())return;let i=console.log,W=F.NONE;switch(r){case 0:{i=console.log,W=F.WHITE;break}case 1:{i=console.debug,W=F.CYAN;break}case 2:{i=console.info,W=F.GREEN;break}case 3:{i=console.warn;break}case 4:{i=console.error;break}}i(ie([ae(o),t].filter(a=>a).join(" "),W))}function de(r,t){_(0,r,t)}function le(r,t){_(1,r,t)}function ue(r,t){_(2,r,t)}function ce(r,t){_(3,r,t)}function me(r,t){_(4,r,t)}var O={setLevel:ne,trace:de,debug:le,info:ue,warn:ce,error:me};var E,m,B,q=class{constructor(t){n(this,E,void 0);n(this,m,[]);n(this,B,void 0);s(this,E,new Worker(ee,{type:"module",name:Z})),s(this,B,t.maxVideoFrameLength)}init(t){return new Promise(o=>{e(this,E).onmessage=i=>{switch(i.data.msg){case"VideoDecoder_sendVideoStreamInfo":{o(i.data.videoStream);break}case"VideoDecoder_sendVideoFrame":{this.push(t,i.data.frame);break}}},e(this,E).postMessage({msg:"Main_requestVideoDecoderStart",sharedState:k(t)})})}async uninit(t){return new Promise(o=>{for(e(this,E).onmessage=i=>{switch(i.data.msg){case"VideoDecoder_notifyClosed":{e(this,E).terminate(),o();break}}};e(this,m).length>0;)this.pop(t);t.videoDecoderShouldBeDead.store(!0),e(this,E).postMessage({msg:"Main_requestVideoDecoderClose"})})}start(){e(this,E).postMessage({msg:"Main_requestVideoDecoderDecode"})}dequeue(t,o){for(;e(this,m).length>0;){if(!e(this,m)[0].timestamp){this.pop(t);continue}let i=e(this,m)[0].timestamp-o*1e6;if(i<-.1*1e6){O.trace("chooseFrame(): frame dropped","WVVideoDecoderWorkerFront"),this.pop(t);continue}else return i>.1*1e6?(O.trace("chooseFrame(): frame too fast","WVVideoDecoderWorkerFront"),null):e(this,m)[0]}return null}front(){return e(this,m).length>0?e(this,m)[0]:null}push(t,o){e(this,m).push(o),e(this,m).length>e(this,B)&&t.videoBufferFull.store(!0)}pop(t){let o=e(this,m).shift();o&&(o.close(),e(this,m).length<e(this,B)&&t.videoBufferFull.store(!1))}};E=new WeakMap,m=new WeakMap,B=new WeakMap;var w,P,Y=class{constructor(t,o){n(this,w,void 0);n(this,P,void 0);s(this,w,t),e(this,w).width=o.video.width,e(this,w).height=o.video.height,s(this,P,t.getContext("2d"))}draw(t){e(this,P).drawImage(t,0,0,t.displayWidth,t.displayHeight)}clear(){e(this,P).clearRect(0,0,e(this,w).width,e(this,w).height)}};w=new WeakMap,P=new WeakMap;var h,V,I,z=class{constructor(t){n(this,h,void 0);n(this,V,void 0);n(this,I,void 0);s(this,h,new AudioContext({sampleRate:44100,latencyHint:"playback"})),e(this,h).suspend()}async init(t,o){return await e(this,h).audioWorklet.addModule(X),s(this,V,new AudioWorkletNode(e(this,h),Q,{processorOptions:{sharedState:k(t)},outputChannelCount:[o.audio.nbChannels]})),s(this,I,new GainNode(e(this,h),{gain:.5})),e(this,V).connect(e(this,I)).connect(e(this,h).destination),e(this,V).port}async start(){await e(this,h).resume()}async pause(){await e(this,h).suspend()}async close(){e(this,I)?.disconnect(),e(this,V)?.disconnect(),e(this,V)?.port.close(),await e(this,h).close()}currentTime(){return Math.max(e(this,h).currentTime-e(this,h).baseLatency,0)}};h=new WeakMap,V=new WeakMap,I=new WeakMap;var N,l,g,v,y,U,K,L,j,b,x=class{constructor(t){n(this,N,void 0);n(this,l,void 0);n(this,g,void 0);n(this,v,void 0);n(this,y,void 0);n(this,U,10);n(this,K,void 0);n(this,L,void 0);n(this,j,void 0);n(this,b,!1);s(this,N,t),s(this,l,{videoUrl:t.videoUrl,loglevel:t.loglevel??u.WARN,playState:new G(c.STOPPED),audioBufferFull:new A(!1),videoBufferFull:new A(!1),videoDecoderShouldBeDead:new A(!1),audioDecoderShouldBeDead:new A(!1)}),O.setLevel(e(this,l).loglevel),s(this,y,new q({maxVideoFrameLength:e(this,U)}))}async load(t){if(e(this,b))throw Error("load() is already called");s(this,b,!0),e(this,l).playState.store(c.BUFFERING),await t?.onStart?.();{s(this,L,await e(this,y).init(e(this,l))),s(this,g,new Y(e(this,N).canvasElem,e(this,L))),s(this,v,new z(null)),e(this,y).start(),await new Promise(i=>{let W=e(this,l);requestAnimationFrame(function a(){if(W.playState.load()!==c.BUFFERING||W.videoBufferFull.load())return i(0);requestAnimationFrame(a)})});let o=e(this,y).front();o&&e(this,g).draw(o)}await t?.onEnd?.(),e(this,l).playState.store(c.PAUSED)}async unload(t){if(!e(this,b))throw Error("load() is not called called");s(this,b,!1),e(this,l).playState.store(c.STOPPED),await t?.onStart?.(),e(this,g)?.clear(),await e(this,v)?.close(),await e(this,y).uninit(e(this,l)),await t?.onEnd?.()}loadCalled(){return e(this,b)}playState(){return e(this,l).playState.load()}canPlay(){return!0}async play(){if(!e(this,v))throw Error("WVAudioRenderer is undefined");e(this,l).playState.store(c.PLAYING),await e(this,v).start(),this.mainLoop()}async pause(){if(!e(this,v))throw Error("WVAudioRenderer is undefined");e(this,l).playState.store(c.PAUSED),await e(this,v).pause()}async mainLoop(){if(e(this,l).playState.load()!==c.PLAYING)return;if(!e(this,g)){O.error("Renderers are not initialized yet","WVPlayer");return}let t=e(this,v).currentTime(),o=e(this,y).dequeue(e(this,l),t);o&&(e(this,g).draw(o),e(this,y).pop(e(this,l))),requestAnimationFrame(this.mainLoop.bind(this))}};N=new WeakMap,l=new WeakMap,g=new WeakMap,v=new WeakMap,y=new WeakMap,U=new WeakMap,K=new WeakMap,L=new WeakMap,j=new WeakMap,b=new WeakMap,x.LogLevel=u;var p,T;(function(o){o.FONTAWESOME_PLAY="&#xf04b;",o.FONTAWESOME_PAUSE="&#xf04c;"})(T||(T={}));function re(r){r.style.display=""}function he(r){r.style.display="none"}function fe(r){r.style.display=""}function oe(r){r.style.display="none"}function $(r,t){t.style.opacity=r?"0":"1"}function H(r,t){t.innerHTML=r}window.addEventListener("beforeunload",r=>{function t(o){let i=new Date().getTime();for(;new Date().getTime()-i<o;);}p?.loadCalled()&&(p?.unload(),t(1e3)),r.preventDefault(),r.returnValue=""});window.addEventListener("load",async()=>{let r=document.querySelector("select#video_select"),t=document.querySelector("#play_btn_wrapper"),o=document.querySelector("#loader_wrapper"),i=document.querySelector("#play_btn");r.addEventListener("change",async W=>{let a=W.target;a.value&&(p?.loadCalled()&&await p?.unload({onEnd:async()=>{oe(t),re(o)}}),p=new x({videoUrl:new URL(a.value,location.origin).href,canvasElem:document.querySelector("#monitor")}),await p.load({onStart:async()=>{oe(t),re(o)},onEnd:async()=>{he(o),fe(t),$(!1,t),H(T.FONTAWESOME_PLAY,i)}}))}),H(T.FONTAWESOME_PLAY,i),i.addEventListener("click",async()=>{if(!!p)switch(p.playState()){case c.PAUSED:{p.canPlay()&&(p.play(),$(!0,t),H(T.FONTAWESOME_PAUSE,i));break}case c.PLAYING:{p.pause(),$(!1,t),H(T.FONTAWESOME_PLAY,i);break}}})});
