var E=(t,e,r)=>{if(!e.has(t))throw TypeError("Cannot "+r)};var s=(t,e,r)=>(E(t,e,"read from private field"),r?r.call(t):e.get(t)),S=(t,e,r)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,r)},g=(t,e,r,i)=>(E(t,e,"write to private field"),i?i.call(t,r):e.set(t,r),r);var v="webvideo-audio-worklet";var a;(function(o){o[o.TRACE=0]="TRACE",o[o.DEBUG=1]="DEBUG",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.ERROR=4]="ERROR"})(a||(a={}));var h;(function(n){n.BLACK="[30m",n.RED="[31m",n.GREEN="[32m",n.YELLOW="[33m",n.BLUE="[34m",n.MAGENTA="[35m",n.CYAN="[36m",n.WHITE="[37m",n.NONE=""})(h||(h={}));function V(t,e){if(e===h.NONE)return t;{let r="[0m";return e+t+r}}function F(t){return t?`[${t}]`:""}var D={loglevel:3};function k(t){typeof self!="undefined"&&(self.__wv_global_loglevel=t),D.loglevel=t}function N(){return typeof self!="undefined"?self.__wv_global_loglevel:D.loglevel}function B(t,e,r){if(t<N())return;let i=console.log,u=h.NONE;switch(t){case 0:{i=console.log,u=h.WHITE;break}case 1:{i=console.debug,u=h.CYAN;break}case 2:{i=console.info,u=h.GREEN;break}case 3:{i=console.warn;break}case 4:{i=console.error;break}}i(V([F(r),e].filter(o=>o).join(" "),u))}function U(t,e){B(0,t,e)}function _(t,e){B(1,t,e)}function T(t,e){B(2,t,e)}function P(t,e){B(3,t,e)}function G(t,e){B(4,t,e)}var b={setLevel:k,trace:U,debug:_,info:T,warn:P,error:G};var W=class{constructor(e){this.options={channels:2,bufLength:128*1e3,thresholdWaitBufLength:-1};this.bufs=[];if(this.bufSet=e.bufSet,this.options.channels=e.options.channels??this.options.channels,this.options.bufLength=e.options.bufLength??this.options.bufLength,this.bufSet.lockSab.byteLength!==4)throw Error("WVAudioRingBuffer Error: ByteLength of WVAudioRingBufferBufferSet.lockSab != 4");if(this.lock=new Int32Array(this.bufSet.lockSab),this.bufSet.idxSabs.length!==2)throw Error("WVAudioRingBuffer Error: Length of WVAudioRingBufferBufferSet.idxSabs != 2");for(let r=0;r<2;r++)if(this.bufSet.idxSabs[r].byteLength!==4)throw Error("WVAudioRingBuffer: ByteLength of WVAudioRingBufferBufferSet.idxSabs[] != 4");if(this.readIdx=new Uint32Array(this.bufSet.idxSabs[0]),this.writeIdx=new Uint32Array(this.bufSet.idxSabs[1]),this.bufSet.bufSabs.length!==this.options.channels)throw Error("WVAudioRingBuffer Error: Length of WVAudioRingBufferBufferSet.bufSabs != WVAudioRingBufferOptions.channels");for(let r=0;r<this.options.channels;r++){if(this.bufSet.bufSabs[r].byteLength!==4*this.options.bufLength)throw Error("WVAudioRingBuffer: ByteLength of WVAudioRingBufferBufferSet.bufSabs[] != WVAudioRingBufferOptions.bufLength");this.bufs.push(new Float32Array(this.bufSet.bufSabs[r]))}}initParams(){return{bufSet:this.bufSet,options:this.options}}writable(){return Atomics.load(this.lock,0)===0}setWritable(e){Atomics.store(this.lock,0,e?0:1),Atomics.notify(this.lock,0)}waitForWritable(e=1/0){for(;!this.writable();)Atomics.wait(this.lock,0,1,e)}availableRead(){let e=Atomics.load(this.readIdx,0),r=Atomics.load(this.writeIdx,0);return r>=e?r-e:this.options.bufLength-(e-r)}availableWrite(){return this.options.bufLength-1-this.availableRead()}full(){return this.availableWrite()<=0}nearlyFull(){return this.availableWrite()<(this.options.thresholdWaitBufLength>0?this.options.thresholdWaitBufLength:this.options.bufLength*.1)}hungry(){return this.availableWrite()>(this.options.thresholdWaitBufLength>0?this.options.thresholdWaitBufLength:this.options.bufLength*.05)}read(e,r=-1){let i=Atomics.load(this.readIdx,0);if(r<0&&(r=e[0].length),r>this.availableRead())return b.error("Read out of range","WVAudioRingBuffer"),!1;for(let u=0;u<e.length;u++)for(let o=0;o<r;o++)e[u][o]=this.bufs[u][(i+o)%this.options.bufLength];return Atomics.store(this.readIdx,0,(i+r)%this.options.bufLength),this.setWritable(this.hungry()),!0}write(e,r=-1){let i=Atomics.load(this.writeIdx,0);if(r<0&&(r=e[0].length),r>this.availableWrite())return b.error("Write out of range","WVAudioRingBuffer"),!1;for(let u=0;u<e.length;++u)for(let o=0;o<r;o++)this.bufs[u][(i+o)%this.options.bufLength]=e[u][o];return Atomics.store(this.writeIdx,0,(i+r)%this.options.bufLength),this.setWritable(!this.nearlyFull()),!0}};function I(t){return{videoUrl:t.videoUrl,loglevel:t.loglevel,playState:x.fromBuffer(t.playState),videoBufferFull:c.fromBuffer(t.videoBufferFull),audioBufferFull:c.fromBuffer(t.audioBufferFull),videoDecoderShouldBeDead:c.fromBuffer(t.videoDecoderShouldBeDead),audioDecoderShouldBeDead:c.fromBuffer(t.audioDecoderShouldBeDead)}}var m;(function(o){o[o.STOPPED=-1]="STOPPED",o[o.PLAYING=0]="PLAYING",o[o.PAUSED=1]="PAUSED",o[o.BUFFERING=2]="BUFFERING",o[o.SEEKING=3]="SEEKING"})(m||(m={}));var l,R=class{constructor(e){S(this,l,void 0);let r=new SharedArrayBuffer(4);g(this,l,new Int32Array(r)),s(this,l)[0]=e}static fromBuffer(e){let r=-1,i=new R(r);return g(i,l,e),i}load(){return Atomics.load(s(this,l),0)}store(e){Atomics.store(s(this,l),0,e),Atomics.notify(s(this,l),0)}buf(){return s(this,l)}},x=R;l=new WeakMap;var f,A,p,d=class{constructor(e){S(this,f,void 0);let r=new SharedArrayBuffer(4);g(this,f,new Int32Array(r)),s(this,f)[0]=e?s(d,A):s(d,p)}static fromBuffer(e){let r=!1,i=new d(r);return g(i,f,e),i}load(){return Atomics.load(s(this,f),0)===s(d,A)}store(e){Atomics.store(s(this,f),0,e?s(d,A):s(d,p)),Atomics.notify(s(this,f),0)}buf(){return s(this,f)}sab(){return s(this,f).buffer}},c=d;f=new WeakMap,A=new WeakMap,p=new WeakMap,S(c,A,1),S(c,p,0);var y=null,w=null,O=class extends AudioWorkletProcessor{constructor(e){super();w=I(e.processorOptions.sharedState),b.setLevel(w.loglevel),this.port.onmessage=r=>{switch(r.data.msg){case"Decoder_sendRingBuffer":{y=new W(r.data.initParams);break}}}}process(e,r){return y?y.read(r[0])?!0:(b.error("Dequeue failed","WVAudioWorkletProcessor"),!1):(b.error("AudioRingBuffer is not yet initialized","WVAudioWorkletProcessor"),!1)}};registerProcessor(v,O);
