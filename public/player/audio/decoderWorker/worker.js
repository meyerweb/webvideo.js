var V=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var d=(r,e,t)=>(V(r,e,"read from private field"),t?t.call(r):e.get(r)),g=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},A=(r,e,t,i)=>(V(r,e,"write to private field"),i?i.call(r,t):e.set(r,t),t);var s;(function(o){o[o.TRACE=0]="TRACE",o[o.DEBUG=1]="DEBUG",o[o.INFO=2]="INFO",o[o.WARN=3]="WARN",o[o.ERROR=4]="ERROR"})(s||(s={}));var b;(function(n){n.BLACK="[30m",n.RED="[31m",n.GREEN="[32m",n.YELLOW="[33m",n.BLUE="[34m",n.MAGENTA="[35m",n.CYAN="[36m",n.WHITE="[37m",n.NONE=""})(b||(b={}));function E(r,e){if(e===b.NONE)return r;{let t="[0m";return e+r+t}}function k(r){return r?`[${r}]`:""}var x={loglevel:3};function F(r){typeof self!="undefined"&&(self.__wv_global_loglevel=r),x.loglevel=r}function P(){return typeof self!="undefined"?self.__wv_global_loglevel:x.loglevel}function W(r,e,t){if(r<P())return;let i=console.log,u=b.NONE;switch(r){case 0:{i=console.log,u=b.WHITE;break}case 1:{i=console.debug,u=b.CYAN;break}case 2:{i=console.info,u=b.GREEN;break}case 3:{i=console.warn;break}case 4:{i=console.error;break}}i(E([k(t),e].filter(o=>o).join(" "),u))}function N(r,e){W(0,r,e)}function U(r,e){W(1,r,e)}function O(r,e){W(2,r,e)}function G(r,e){W(3,r,e)}function L(r,e){W(4,r,e)}var c={setLevel:F,trace:N,debug:U,info:O,warn:G,error:L};var p=class{constructor(e){this.options={channels:2,bufLength:128*1e3,thresholdWaitBufLength:-1};this.bufs=[];if(this.bufSet=e.bufSet,this.options.channels=e.options.channels??this.options.channels,this.options.bufLength=e.options.bufLength??this.options.bufLength,this.bufSet.lockSab.byteLength!==4)throw Error("WVAudioRingBuffer Error: ByteLength of WVAudioRingBufferBufferSet.lockSab != 4");if(this.lock=new Int32Array(this.bufSet.lockSab),this.bufSet.idxSabs.length!==2)throw Error("WVAudioRingBuffer Error: Length of WVAudioRingBufferBufferSet.idxSabs != 2");for(let t=0;t<2;t++)if(this.bufSet.idxSabs[t].byteLength!==4)throw Error("WVAudioRingBuffer: ByteLength of WVAudioRingBufferBufferSet.idxSabs[] != 4");if(this.readIdx=new Uint32Array(this.bufSet.idxSabs[0]),this.writeIdx=new Uint32Array(this.bufSet.idxSabs[1]),this.bufSet.bufSabs.length!==this.options.channels)throw Error("WVAudioRingBuffer Error: Length of WVAudioRingBufferBufferSet.bufSabs != WVAudioRingBufferOptions.channels");for(let t=0;t<this.options.channels;t++){if(this.bufSet.bufSabs[t].byteLength!==4*this.options.bufLength)throw Error("WVAudioRingBuffer: ByteLength of WVAudioRingBufferBufferSet.bufSabs[] != WVAudioRingBufferOptions.bufLength");this.bufs.push(new Float32Array(this.bufSet.bufSabs[t]))}}initParams(){return{bufSet:this.bufSet,options:this.options}}writable(){return Atomics.load(this.lock,0)===0}setWritable(e){Atomics.store(this.lock,0,e?0:1),Atomics.notify(this.lock,0)}waitForWritable(e=1/0){for(;!this.writable();)Atomics.wait(this.lock,0,1,e)}availableRead(){let e=Atomics.load(this.readIdx,0),t=Atomics.load(this.writeIdx,0);return t>=e?t-e:this.options.bufLength-(e-t)}availableWrite(){return this.options.bufLength-1-this.availableRead()}full(){return this.availableWrite()<=0}nearlyFull(){return this.availableWrite()<(this.options.thresholdWaitBufLength>0?this.options.thresholdWaitBufLength:this.options.bufLength*.1)}hungry(){return this.availableWrite()>(this.options.thresholdWaitBufLength>0?this.options.thresholdWaitBufLength:this.options.bufLength*.05)}read(e,t=-1){let i=Atomics.load(this.readIdx,0);if(t<0&&(t=e[0].length),t>this.availableRead())return c.error("Read out of range","WVAudioRingBuffer"),!1;for(let u=0;u<e.length;u++)for(let o=0;o<t;o++)e[u][o]=this.bufs[u][(i+o)%this.options.bufLength];return Atomics.store(this.readIdx,0,(i+t)%this.options.bufLength),this.setWritable(this.hungry()),!0}write(e,t=-1){let i=Atomics.load(this.writeIdx,0);if(t<0&&(t=e[0].length),t>this.availableWrite())return c.error("Write out of range","WVAudioRingBuffer"),!1;for(let u=0;u<e.length;++u)for(let o=0;o<t;o++)this.bufs[u][(i+o)%this.options.bufLength]=e[u][o];return Atomics.store(this.writeIdx,0,(i+t)%this.options.bufLength),this.setWritable(!this.nearlyFull()),!0}};function v(r){return{videoUrl:r.videoUrl,loglevel:r.loglevel,playState:R.fromBuffer(r.playState),videoBufferFull:m.fromBuffer(r.videoBufferFull),audioBufferFull:m.fromBuffer(r.audioBufferFull),videoDecoderShouldBeDead:m.fromBuffer(r.videoDecoderShouldBeDead),audioDecoderShouldBeDead:m.fromBuffer(r.audioDecoderShouldBeDead)}}var y;(function(o){o[o.STOPPED=-1]="STOPPED",o[o.PLAYING=0]="PLAYING",o[o.PAUSED=1]="PAUSED",o[o.BUFFERING=2]="BUFFERING",o[o.SEEKING=3]="SEEKING"})(y||(y={}));var l,D=class{constructor(e){g(this,l,void 0);let t=new SharedArrayBuffer(4);A(this,l,new Int32Array(t)),d(this,l)[0]=e}static fromBuffer(e){let t=-1,i=new D(t);return A(i,l,e),i}load(){return Atomics.load(d(this,l),0)}store(e){Atomics.store(d(this,l),0,e),Atomics.notify(d(this,l),0)}buf(){return d(this,l)}},R=D;l=new WeakMap;var f,S,B,h=class{constructor(e){g(this,f,void 0);let t=new SharedArrayBuffer(4);A(this,f,new Int32Array(t)),d(this,f)[0]=e?d(h,S):d(h,B)}static fromBuffer(e){let t=!1,i=new h(t);return A(i,f,e),i}load(){return Atomics.load(d(this,f),0)===d(h,S)}store(e){Atomics.store(d(this,f),0,e?d(h,S):d(h,B)),Atomics.notify(d(this,f),0)}buf(){return d(this,f)}sab(){return d(this,f).buffer}},m=h;f=new WeakMap,S=new WeakMap,B=new WeakMap,g(m,S,1),g(m,B,0);function I(r){return new Promise(e=>{setTimeout(()=>{e()},r)})}async function w(r="MP4Box"){let e=await import(new URL(`./media/format/demuxer${r}.js`,location.origin).href);return new e.MP4BoxMediaDemuxer}async function M(r="WebCodecs",e){let t=await import(new URL(`./media/codec/decoder${r}.js`,location.origin).href);return new t.WebCodecsMediaDecoder(e)}var a={};async function T(r,e){for(;!r.ringBuf.writable();)if(r.ringBuf.waitForWritable(10*1e3),r.sharedState.audioDecoderShouldBeDead.load())return;r.ringBuf.write(e.info().audio.bufs)}function z(r){let e={channels:r.audioStream.audio.nbChannels,bufLength:128*400,thresholdWaitBufLength:1024},t={bufSabs:[],lockSab:r.sharedState.audioBufferFull.sab(),idxSabs:[new SharedArrayBuffer(4),new SharedArrayBuffer(4)]};for(let i=0;i<e.channels;i++)t.bufSabs.push(new SharedArrayBuffer(4*e.bufLength));return new p({bufSet:t,options:e})}self.addEventListener("message",async r=>{switch(r.data.msg){case"Main_requestAudioDecoderStart":{a.sharedState=v(r.data.sharedState),c.setLevel(a.sharedState.loglevel),a.decoder=await M("WebCodecs",await w("MP4Box"));let e=await a.decoder.open(a.sharedState.videoUrl,"audio");if(a.audioStream=e.streams.filter(t=>t.type==="audio")[0],!a.audioStream){c.error("No audio stream found","WVAudioDecoderWorker");return}a.ringBuf=z(a),self.postMessage({msg:"AudioDecoder_sendAudioStreamInfo",audioStream:a.audioStream});break}case"Main_requestAudioDecoderDecode":{if(!a.audioStream||!a.decoder||!a.ringBuf){c.error("AudioDecoderWorkerState is not initialized","WVAudioDecoderWorker");return}a.audioWorkerPort=r.ports[0],a.audioWorkerPort.postMessage({msg:"Decoder_sendRingBuffer",initParams:a.ringBuf.initParams()});for await(let e of a.decoder.decode(a.audioStream.streamIndex)){if(a.sharedState.audioDecoderShouldBeDead.load())break;if(e.eof){c.debug("eof detected","WVAudioDecoderWorker");break}if(e.frame&&e.frame.type()==="audio"){await T(a,e.frame),e.frame.close();continue}await I(4)}break}case"Main_requestAudioDecoderClose":{a.decoder&&await a.decoder.destroy(),self.postMessage({msg:"AudioDecoder_notifyClosed"});break}}});
